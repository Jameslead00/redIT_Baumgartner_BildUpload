{"ast":null,"code":"// Interface für Benutzer-Erwähnungen\n// Füge Interfaces für Adaptive Card-Elemente hinzu\n// Hilfsfunktion, um Bild von URL zu laden und als base64 zu encoden (mit Auth)\nconst loadImageAsBase64=async(url,accessToken)=>{const response=await fetch(url,{headers:{Authorization:\"Bearer \".concat(accessToken)}});const blob=await response.blob();return new Promise((resolve,reject)=>{const reader=new FileReader();reader.onload=()=>resolve(reader.result);reader.onerror=reject;reader.readAsDataURL(blob);});};// Hilfsfunktion: Bild für Hosted Content vorbereiten (Resize + Raw Base64)\nconst prepareImageForHostedContent=file=>{return new Promise((resolve,reject)=>{const img=new Image();img.onload=()=>{const canvas=document.createElement('canvas');const ctx=canvas.getContext('2d');// Max Größe für Display (z.B. 1024px), um Request-Größe klein zu halten (<4MB total)\nconst maxDim=1024;let{width,height}=img;if(width>height){if(width>maxDim){height=height*maxDim/width;width=maxDim;}}else{if(height>maxDim){width=width*maxDim/height;height=maxDim;}}canvas.width=width;canvas.height=height;ctx.drawImage(img,0,0,width,height);// Zu Blob und dann Base64 (ohne Prefix)\ncanvas.toBlob(blob=>{if(blob){const reader=new FileReader();reader.onload=()=>{const result=reader.result;// Entferne \"data:image/jpeg;base64,\" Prefix\nresolve(result.split(',')[1]);};reader.onerror=reject;reader.readAsDataURL(blob);}else{reject(new Error('Canvas toBlob failed'));}},'image/jpeg',0.8);// Gute Qualität für Anzeige\n};img.onerror=reject;img.src=URL.createObjectURL(file);});};// Hilfsfunktion für HTML Escaping (WICHTIG für Namen mit Sonderzeichen)\nconst escapeHtml=str=>{return str.replace(/[&<>\"']/g,m=>{switch(m){case'&':return'&amp;';case'<':return'&lt;';case'>':return'&gt;';case'\"':return'&quot;';case\"'\":return'&#39;';default:return m;}});};export const postMessageToChannel=async function(accessToken,teamId,channelId,customText,imageUrls,files){let mentions=arguments.length>6&&arguments[6]!==undefined?arguments[6]:[];// 1. Hosted Contents vorbereiten\nconst hostedContents=await Promise.all(files.map(async(file,index)=>{const contentBytes=await prepareImageForHostedContent(file);return{\"@microsoft.graph.temporaryId\":(index+1).toString(),\"contentBytes\":contentBytes,\"contentType\":\"image/jpeg\"};}));// 2. Mentions vorbereiten\n// WICHTIG: Filtere ungültige User ohne ID heraus, um Fehler zu vermeiden\nconst validMentions=mentions.filter(u=>u.id&&u.displayName);const mentionEntities=validMentions.map((user,index)=>({id:index,// ID muss mit dem id im <at> Tag übereinstimmen (Integer im JSON)\nmentionText:user.displayName,// Plain Text im JSON\nmentioned:{user:{id:user.id,displayName:user.displayName,userIdentityType:\"aadUser\"}}}));// HTML für Mentions erstellen (z.B. \"<at id=\"0\">Max Mustermann</at>\")\n// WICHTIG: escapeHtml nutzen, damit Sonderzeichen das Tag nicht brechen\nconst mentionsHtml=validMentions.map((user,index)=>\"<at id=\\\"\".concat(index,\"\\\">\").concat(escapeHtml(user.displayName),\"</at>\")).join(' ');// 3. HTML Body erstellen\nconst imagesHtml=hostedContents.map((hc,index)=>{const id=hc[\"@microsoft.graph.temporaryId\"];const oneDriveUrl=imageUrls[index]||\"#\";return\"\\n            <div style=\\\"margin-bottom: 16px;\\\">\\n                <img src=\\\"../hostedContents/\".concat(id,\"/$value\\\" style=\\\"max-width: 100%; width: auto; border-radius: 4px; display: block;\\\" alt=\\\"Image \").concat(index+1,\"\\\">\\n                <div style=\\\"margin-top: 4px;\\\">\\n                    <a href=\\\"\").concat(oneDriveUrl,\"\\\" target=\\\"_blank\\\" style=\\\"font-size: 12px; color: #5b5fc7; text-decoration: none;\\\">\\n                        Original anzeigen \\u2197\\n                    </a>\\n                </div>\\n            </div>\");}).join('');// Text zusammenbauen: Mentions vor dem eigentlichen Text\n// Wir nutzen <p> für den Text-Block\nconst textContent=mentionsHtml?\"<p>\".concat(mentionsHtml,\" \").concat(escapeHtml(customText||\"\"),\"</p>\"):\"<p style=\\\"font-size: 14px; font-weight: bold; margin-bottom: 12px;\\\">\".concat(escapeHtml(customText||\"Neue Bilder hochgeladen: \"),\"</p>\");const messagePayload={body:{contentType:\"html\",content:\"\\n                <div>\\n                    \".concat(textContent,\"\\n                    <div style=\\\"display: flex; flex-direction: column; gap: 10px;\\\">\\n                        \").concat(imagesHtml,\"\\n                    </div>\\n                </div>\\n            \")},hostedContents:hostedContents,mentions:mentionEntities// Mentions zur Payload hinzufügen\n};// 4. Senden\nconst messageResponse=await fetch(\"https://graph.microsoft.com/v1.0/teams/\".concat(teamId,\"/channels/\").concat(channelId,\"/messages\"),{method:\"POST\",headers:{Authorization:\"Bearer \".concat(accessToken),\"Content-Type\":\"application/json\"},body:JSON.stringify(messagePayload)});if(!messageResponse.ok){const responseText=await messageResponse.text();throw new Error(\"Failed to post message to channel: \".concat(messageResponse.status,\" \").concat(responseText));}};","map":{"version":3,"names":["loadImageAsBase64","url","accessToken","response","fetch","headers","Authorization","concat","blob","Promise","resolve","reject","reader","FileReader","onload","result","onerror","readAsDataURL","prepareImageForHostedContent","file","img","Image","canvas","document","createElement","ctx","getContext","maxDim","width","height","drawImage","toBlob","split","Error","src","URL","createObjectURL","escapeHtml","str","replace","m","postMessageToChannel","teamId","channelId","customText","imageUrls","files","mentions","arguments","length","undefined","hostedContents","all","map","index","contentBytes","toString","validMentions","filter","u","id","displayName","mentionEntities","user","mentionText","mentioned","userIdentityType","mentionsHtml","join","imagesHtml","hc","oneDriveUrl","textContent","messagePayload","body","contentType","content","messageResponse","method","JSON","stringify","ok","responseText","text","status"],"sources":["/home/vsts/work/1/s/src/ui-components/PostMessage.tsx"],"sourcesContent":["import React from 'react';\n\n// Interface für Benutzer-Erwähnungen\nexport interface MentionUser {\n    id: string;\n    displayName: string;\n}\n\n// Füge Interfaces für Adaptive Card-Elemente hinzu\ninterface AdaptiveCardElement {\n    type: string;\n}\n\ninterface TextBlock extends AdaptiveCardElement {\n    type: \"TextBlock\";\n    text: string;\n    weight?: string;\n    size?: string;\n}\n\ninterface Image extends AdaptiveCardElement {\n    type: \"Image\";\n    url: string;\n    size?: string;\n    selectAction?: {\n        type: \"Action.OpenUrl\";\n        url: string;\n    };\n}\n\n// Hilfsfunktion, um Bild von URL zu laden und als base64 zu encoden (mit Auth)\nconst loadImageAsBase64 = async (url: string, accessToken: string): Promise<string> => {\n    const response = await fetch(url, {\n        headers: {\n            Authorization: `Bearer ${accessToken}`,\n        },\n    });\n    const blob = await response.blob();\n    return new Promise((resolve, reject) => {\n        const reader = new FileReader();\n        reader.onload = () => resolve(reader.result as string);\n        reader.onerror = reject;\n        reader.readAsDataURL(blob);\n    });\n};\n\n// Hilfsfunktion: Bild für Hosted Content vorbereiten (Resize + Raw Base64)\nconst prepareImageForHostedContent = (file: File): Promise<string> => {\n    return new Promise((resolve, reject) => {\n        const img = new Image();\n        img.onload = () => {\n            const canvas = document.createElement('canvas');\n            const ctx = canvas.getContext('2d')!;\n            \n            // Max Größe für Display (z.B. 1024px), um Request-Größe klein zu halten (<4MB total)\n            const maxDim = 1024; \n            let { width, height } = img;\n            \n            if (width > height) {\n                if (width > maxDim) {\n                    height = (height * maxDim) / width;\n                    width = maxDim;\n                }\n            } else {\n                if (height > maxDim) {\n                    width = (width * maxDim) / height;\n                    height = maxDim;\n                }\n            }\n            \n            canvas.width = width;\n            canvas.height = height;\n            ctx.drawImage(img, 0, 0, width, height);\n            \n            // Zu Blob und dann Base64 (ohne Prefix)\n            canvas.toBlob((blob) => {\n                if (blob) {\n                    const reader = new FileReader();\n                    reader.onload = () => {\n                        const result = reader.result as string;\n                        // Entferne \"data:image/jpeg;base64,\" Prefix\n                        resolve(result.split(',')[1]);\n                    };\n                    reader.onerror = reject;\n                    reader.readAsDataURL(blob);\n                } else {\n                    reject(new Error('Canvas toBlob failed'));\n                }\n            }, 'image/jpeg', 0.8); // Gute Qualität für Anzeige\n        };\n        img.onerror = reject;\n        img.src = URL.createObjectURL(file);\n    });\n};\n\n// Hilfsfunktion für HTML Escaping (WICHTIG für Namen mit Sonderzeichen)\nconst escapeHtml = (str: string) => {\n    return str.replace(/[&<>\"']/g, (m) => {\n        switch (m) {\n            case '&': return '&amp;';\n            case '<': return '&lt;';\n            case '>': return '&gt;';\n            case '\"': return '&quot;';\n            case \"'\": return '&#39;';\n            default: return m;\n        }\n    });\n};\n\nexport const postMessageToChannel = async (\n    accessToken: string,\n    teamId: string,\n    channelId: string,\n    customText: string,\n    imageUrls: string[],\n    files: File[],\n    mentions: MentionUser[] = [] \n): Promise<void> => {\n    \n    // 1. Hosted Contents vorbereiten\n    const hostedContents = await Promise.all(files.map(async (file, index) => {\n        const contentBytes = await prepareImageForHostedContent(file);\n        return {\n            \"@microsoft.graph.temporaryId\": (index + 1).toString(),\n            \"contentBytes\": contentBytes,\n            \"contentType\": \"image/jpeg\"\n        };\n    }));\n\n    // 2. Mentions vorbereiten\n    // WICHTIG: Filtere ungültige User ohne ID heraus, um Fehler zu vermeiden\n    const validMentions = mentions.filter(u => u.id && u.displayName);\n\n    const mentionEntities = validMentions.map((user, index) => ({\n        id: index, // ID muss mit dem id im <at> Tag übereinstimmen (Integer im JSON)\n        mentionText: user.displayName, // Plain Text im JSON\n        mentioned: {\n            user: {\n                id: user.id,\n                displayName: user.displayName,\n                userIdentityType: \"aadUser\"\n            }\n        }\n    }));\n\n    // HTML für Mentions erstellen (z.B. \"<at id=\"0\">Max Mustermann</at>\")\n    // WICHTIG: escapeHtml nutzen, damit Sonderzeichen das Tag nicht brechen\n    const mentionsHtml = validMentions.map((user, index) => `<at id=\"${index}\">${escapeHtml(user.displayName)}</at>`).join(' ');\n\n    // 3. HTML Body erstellen\n    const imagesHtml = hostedContents.map((hc, index) => {\n        const id = hc[\"@microsoft.graph.temporaryId\"];\n        const oneDriveUrl = imageUrls[index] || \"#\";\n        return `\n            <div style=\"margin-bottom: 16px;\">\n                <img src=\"../hostedContents/${id}/$value\" style=\"max-width: 100%; width: auto; border-radius: 4px; display: block;\" alt=\"Image ${index + 1}\">\n                <div style=\"margin-top: 4px;\">\n                    <a href=\"${oneDriveUrl}\" target=\"_blank\" style=\"font-size: 12px; color: #5b5fc7; text-decoration: none;\">\n                        Original anzeigen ↗\n                    </a>\n                </div>\n            </div>`;\n    }).join('');\n\n    // Text zusammenbauen: Mentions vor dem eigentlichen Text\n    // Wir nutzen <p> für den Text-Block\n    const textContent = mentionsHtml \n        ? `<p>${mentionsHtml} ${escapeHtml(customText || \"\")}</p>` \n        : `<p style=\"font-size: 14px; font-weight: bold; margin-bottom: 12px;\">${escapeHtml(customText || \"Neue Bilder hochgeladen: \")}</p>`;\n\n    const messagePayload = {\n        body: {\n            contentType: \"html\",\n            content: `\n                <div>\n                    ${textContent}\n                    <div style=\"display: flex; flex-direction: column; gap: 10px;\">\n                        ${imagesHtml}\n                    </div>\n                </div>\n            `\n        },\n        hostedContents: hostedContents,\n        mentions: mentionEntities // Mentions zur Payload hinzufügen\n    };\n\n    // 4. Senden\n    const messageResponse = await fetch(`https://graph.microsoft.com/v1.0/teams/${teamId}/channels/${channelId}/messages`, {\n        method: \"POST\",\n        headers: {\n            Authorization: `Bearer ${accessToken}`,\n            \"Content-Type\": \"application/json\",\n        },\n        body: JSON.stringify(messagePayload),\n    });\n    \n    if (!messageResponse.ok) {\n        const responseText = await messageResponse.text();\n        throw new Error(`Failed to post message to channel: ${messageResponse.status} ${responseText}`);\n    }\n};"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}