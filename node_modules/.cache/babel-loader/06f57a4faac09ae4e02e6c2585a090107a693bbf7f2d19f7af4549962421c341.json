{"ast":null,"code":"import _objectSpread from\"/home/vsts/work/1/s/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";import React,{useEffect,useState,useMemo}from\"react\";import{useMsal,useAccount}from\"@azure/msal-react\";import{InteractionRequiredAuthError}from\"@azure/msal-browser\";import{loginRequest}from\"../authConfig\";import{db}from'../db';// Import SubFolder\nimport{logToSharePoint}from\"../utils/Logger\";import ChannelsList from\"./ChannelsList\";import{postMessageToChannel}from\"./PostMessage\";// MentionUser importieren\nimport{Autocomplete,TextField,Button,Typography,Box,Alert,IconButton}from\"@mui/material\";import{Star,StarBorder}from\"@mui/icons-material\";import{checkFolderExists,createFolder,uploadLargeFile,uploadSmallFile,getFolderPath}from'./ImageUpload';import{jsx as _jsx,jsxs as _jsxs,Fragment as _Fragment}from\"react/jsx-runtime\";const TeamsList=()=>{var _cachedFavorites$find,_cachedFavorites$find2;const{instance,accounts}=useMsal();const account=useAccount(accounts[0]||{});const[teams,setTeams]=useState([]);const[loading,setLoading]=useState(true);const[error,setError]=useState(null);const[selectedTeam,setSelectedTeam]=useState(null);const[selectedChannel,setSelectedChannel]=useState(null);const[uploadSuccess,setUploadSuccess]=useState(false);const[customText,setCustomText]=useState(\"\");const[imageUrls,setImageUrls]=useState([]);const[posting,setPosting]=useState(false);const[favorites,setFavorites]=useState(new Set());const[isOnline,setIsOnline]=useState(navigator.onLine);const[offlinePosts,setOfflinePosts]=useState([]);const[cachedFavorites,setCachedFavorites]=useState([]);const[uploadedFiles,setUploadedFiles]=useState([]);// Neue States für Mentions\nconst[teamMembers,setTeamMembers]=useState([]);const[selectedMentions,setSelectedMentions]=useState([]);// Online-Status überwachen\nuseEffect(()=>{const handleOnline=()=>setIsOnline(true);const handleOffline=()=>setIsOnline(false);window.addEventListener('online',handleOnline);window.addEventListener('offline',handleOffline);return()=>{window.removeEventListener('online',handleOnline);window.removeEventListener('offline',handleOffline);};},[]);// Sortiere Teams: Favoriten zuerst\nconst sortedTeams=useMemo(()=>{return[...teams].sort((a,b)=>{const aFav=favorites.has(a.id);const bFav=favorites.has(b.id);if(aFav&&!bFav)return-1;if(!aFav&&bFav)return 1;return a.displayName.localeCompare(b.displayName);});},[teams,favorites]);// Lade gecachte Favoriten und Offline-Posts\nuseEffect(()=>{const loadCachedData=async()=>{const cached=await db.favoriteTeams.toArray();setCachedFavorites(cached);const posts=await db.posts.toArray();setOfflinePosts(posts);};loadCachedData();},[]);useEffect(()=>{const stored=localStorage.getItem('favoriteTeams');setFavorites(stored?new Set(JSON.parse(stored)):new Set());},[]);useEffect(()=>{const fetchTeams=async()=>{if(!account||!isOnline){setLoading(false);// Setze loading auf false, wenn kein account oder offline\nreturn;}const request=_objectSpread(_objectSpread({},loginRequest),{},{account});try{const response=await instance.acquireTokenSilent(request);const accessToken=response.accessToken;const graphResponse=await fetch(\"https://graph.microsoft.com/v1.0/me/joinedTeams\",{headers:{Authorization:\"Bearer \".concat(accessToken)}});if(graphResponse.ok){const data=await graphResponse.json();setTeams(data.value);}else{setError(\"Failed to fetch teams\");}}catch(err){if(err instanceof InteractionRequiredAuthError){instance.acquireTokenPopup(request).then(response=>{const accessToken=response.accessToken;fetch(\"https://graph.microsoft.com/v1.0/me/joinedTeams\",{headers:{Authorization:\"Bearer \".concat(accessToken)}}).then(res=>res.json()).then(data=>setTeams(data.value));});}else{setError(\"Error fetching teams\");}}finally{setLoading(false);}};fetchTeams();// Entferne loadAndCacheChannelsForFavorites aus useEffect, um Loop zu vermeiden\n},[instance,account,isOnline]);// Entferne favorites aus dependencies, um Loop zu vermeiden\n// Neuer useEffect für Kanäle, Mitglieder UND Subfolders Caching\nuseEffect(()=>{const loadAndCacheDataForFavorites=async()=>{if(!account||!isOnline||favorites.size===0)return;const request=_objectSpread(_objectSpread({},loginRequest),{},{account});const response=await instance.acquireTokenSilent(request);const accessToken=response.accessToken;for(const favId of favorites){const team=teams.find(t=>t.id===favId)||cachedFavorites.find(f=>f.id===favId);const cachedFav=cachedFavorites.find(f=>f.id===favId);if(team){let channels=cachedFav===null||cachedFav===void 0?void 0:cachedFav.channels;let members=cachedFav===null||cachedFav===void 0?void 0:cachedFav.members;let channelSubFolders=(cachedFav===null||cachedFav===void 0?void 0:cachedFav.channelSubFolders)||{};// Load existing\nlet needsUpdate=false;// 1. Kanäle laden falls fehlen\nif(!channels){try{const channelsResponse=await fetch(\"https://graph.microsoft.com/v1.0/teams/\".concat(favId,\"/channels\"),{headers:{Authorization:\"Bearer \".concat(accessToken)}});if(channelsResponse.ok){const channelsData=await channelsResponse.json();channels=channelsData.value;needsUpdate=true;}}catch(err){console.error(\"Fehler beim Laden von Kan\\xE4len f\\xFCr \".concat(favId,\":\"),err);}}// 2. Mitglieder laden falls fehlen (NEU)\nif(!members){try{const membersResponse=await fetch(\"https://graph.microsoft.com/v1.0/teams/\".concat(favId,\"/members\"),{headers:{Authorization:\"Bearer \".concat(accessToken)}});if(membersResponse.ok){const membersData=await membersResponse.json();members=membersData.value.filter(m=>m.userId).map(m=>({id:m.userId,displayName:m.displayName}));needsUpdate=true;}}catch(err){console.error(\"Fehler beim Laden von Mitgliedern f\\xFCr \".concat(favId,\":\"),err);}}// 3. Subfolders für jeden Kanal laden (NEW)\nif(channels){// Get Site ID first (needed for drive queries)\ntry{const siteResponse=await fetch(\"https://graph.microsoft.com/v1.0/groups/\".concat(favId,\"/sites/root\"),{headers:{Authorization:\"Bearer \".concat(accessToken)}});if(siteResponse.ok){const siteData=await siteResponse.json();const siteId=siteData.id;for(const channel of channels){// Always try to update, or check if missing\n// If we want to refresh cache, we should probably do it.\n// For now, let's check if it's missing or empty\nconst folderPath=getFolderPath(channel.displayName);try{const childrenResponse=await fetch(\"https://graph.microsoft.com/v1.0/sites/\".concat(siteId,\"/drive/root:/\").concat(folderPath,\":/children?filter=folder ne null&select=id,name\"),{headers:{Authorization:\"Bearer \".concat(accessToken)}});if(childrenResponse.ok){const data=await childrenResponse.json();const subs=data.value.map(item=>({id:item.id,name:item.name}));channelSubFolders[channel.id]=subs;needsUpdate=true;}else if(childrenResponse.status===404){// Folder doesn't exist -> Empty list\nchannelSubFolders[channel.id]=[];needsUpdate=true;}}catch(e){console.warn(\"Could not fetch subfolders for channel \".concat(channel.displayName),e);}}}}catch(e){console.error(\"Error fetching site ID for subfolders\",e);}}// Wenn Daten aktualisiert wurden, in DB speichern\nif(needsUpdate&&channels){const newFavData={id:favId,displayName:team.displayName,channels:channels,members:members||[],channelSubFolders:channelSubFolders// Save subfolders\n};await db.favoriteTeams.put(newFavData);// State aktualisieren\nsetCachedFavorites(prev=>{const idx=prev.findIndex(f=>f.id===favId);if(idx>=0){const newArr=[...prev];newArr[idx]=newFavData;return newArr;}return[...prev,newFavData];});}}}};loadAndCacheDataForFavorites();},[favorites,account,isOnline,teams]);// cachedFavorites aus Deps entfernt um Loop zu vermeiden\nconst toggleFavorite=async teamId=>{const newFavorites=new Set(favorites);if(newFavorites.has(teamId)){newFavorites.delete(teamId);await db.favoriteTeams.delete(teamId);// Aus Cache entfernen\n}else{newFavorites.add(teamId);// Cache Team, Kanäle und Mitglieder (nur online)\nif(isOnline&&account){const team=teams.find(t=>t.id===teamId);if(team){const request=_objectSpread(_objectSpread({},loginRequest),{},{account});const response=await instance.acquireTokenSilent(request);const accessToken=response.accessToken;// Kanäle laden\nconst channelsResponse=await fetch(\"https://graph.microsoft.com/v1.0/teams/\".concat(teamId,\"/channels\"),{headers:{Authorization:\"Bearer \".concat(accessToken)}});const channelsData=await channelsResponse.json();// Mitglieder laden (NEU)\nlet members=[];try{const membersResponse=await fetch(\"https://graph.microsoft.com/v1.0/teams/\".concat(teamId,\"/members\"),{headers:{Authorization:\"Bearer \".concat(accessToken)}});if(membersResponse.ok){const mData=await membersResponse.json();members=mData.value.filter(m=>m.userId).map(m=>({id:m.userId,displayName:m.displayName}));}}catch(e){console.error(\"Failed to fetch members for fav\",e);}const favData={id:teamId,displayName:team.displayName,channels:channelsData.value,members:members};await db.favoriteTeams.put(favData);// Cache State sofort aktualisieren\nsetCachedFavorites(prev=>[...prev.filter(f=>f.id!==teamId),favData]);}}}setFavorites(newFavorites);localStorage.setItem('favoriteTeams',JSON.stringify([...newFavorites]));};// Mitglieder laden: Teil 1 - Aus Cache (reagiert auf Cache-Updates)\nuseEffect(()=>{if(!selectedTeam){setTeamMembers([]);return;}// Wir suchen im State 'cachedFavorites'\nconst cachedTeam=cachedFavorites.find(f=>f.id===selectedTeam.id);// Prüfen ob Mitglieder im Cache sind\nif(cachedTeam!==null&&cachedTeam!==void 0&&cachedTeam.members&&cachedTeam.members.length>0){console.log(\"Lade Mitglieder aus Cache f\\xFCr \".concat(selectedTeam.displayName,\" (\").concat(cachedTeam.members.length,\" Mitglieder)\"));setTeamMembers(cachedTeam.members);}else if(!isOnline){// Offline und kein Cache -> leer\nconsole.warn(\"Offline und keine Mitglieder im Cache für dieses Team.\");setTeamMembers([]);}},[selectedTeam,cachedFavorites,isOnline]);// Mitglieder laden: Teil 2 - Von API (reagiert NICHT auf cachedFavorites -> verhindert Loop)\nuseEffect(()=>{let isMounted=true;const fetchMembersAPI=async()=>{if(!selectedTeam||!account||!isOnline)return;console.log(\"Lade Mitglieder f\\xFCr Team (API): \".concat(selectedTeam.displayName));const request=_objectSpread(_objectSpread({},loginRequest),{},{account});try{let accessToken;try{const response=await instance.acquireTokenSilent(request);accessToken=response.accessToken;}catch(err){if(err instanceof InteractionRequiredAuthError){return;}throw err;}const res=await fetch(\"https://graph.microsoft.com/v1.0/teams/\".concat(selectedTeam.id,\"/members\"),{headers:{Authorization:\"Bearer \".concat(accessToken)}});if(res.ok){const data=await res.json();if(isMounted){const members=data.value.filter(m=>m.userId&&m.displayName).map(m=>({id:m.userId,displayName:m.displayName}));setTeamMembers(members);// Cache aktualisieren, falls es ein Favorit ist\nif(favorites.has(selectedTeam.id)){const currentFav=await db.favoriteTeams.get(selectedTeam.id);if(currentFav){const updatedFav=_objectSpread(_objectSpread({},currentFav),{},{members});await db.favoriteTeams.put(updatedFav);// Dies triggert Effect 1, aber nicht diesen Effect 2!\nsetCachedFavorites(prev=>prev.map(f=>f.id===selectedTeam.id?updatedFav:f));}}}}}catch(e){console.error(\"Fehler beim Laden der Mitglieder\",e);}};fetchMembersAPI();return()=>{isMounted=false;};},[selectedTeam,account,isOnline,instance,favorites]);// WICHTIG: cachedFavorites entfernt!\nconst handleTeamSelect=(event,value)=>{setSelectedTeam(value);setUploadSuccess(false);setCustomText(\"\");setImageUrls([]);setUploadedFiles([]);setSelectedMentions([]);// Reset Mentions\n};// Kombiniere online Teams mit gecachten Favoriten für Offline\nconst availableTeams=useMemo(()=>{if(isOnline&&teams.length>0)return sortedTeams;return cachedFavorites.map(fav=>({id:fav.id,displayName:fav.displayName}));// Offline: Nur gecachte\n},[isOnline,teams,sortedTeams,cachedFavorites]);// Füge syncPost Funktion hinzu (falls nicht vorhanden)\n// ÄNDERUNG: Callback Signatur angepasst\nconst syncPost=async(post,onProgress)=>{if(!account||!isOnline)return;setPosting(true);try{console.log('Starte Sync für Post:',post.id);const request=_objectSpread(_objectSpread({},loginRequest),{},{account});const response=await instance.acquireTokenSilent(request);const accessToken=response.accessToken;// Bilder aus Dexie laden\nconst images=await db.images.where('postId').equals(post.id).toArray();const files=images.map(img=>img.file);// HINWEIS: encodeFilesToBase64 wird nicht mehr benötigt für den Post\n// Ordner und Site-ID prüfen\nconst siteResponse=await fetch(\"https://graph.microsoft.com/v1.0/groups/\".concat(post.teamId,\"/sites/root\"),{headers:{Authorization:\"Bearer \".concat(accessToken)}});const siteData=await siteResponse.json();const siteId=siteData.id;console.log('Site ID:',siteId);// Bestimme den Ordner-Pfad\nlet folderPath=getFolderPath(post.channelDisplayName);// NEW: Append Subfolder if exists\nif(post.subFolder){folderPath=\"\".concat(folderPath,\"/\").concat(post.subFolder);}console.log('Verwende Ordner-Pfad:',folderPath);// Ordner prüfen/erstellen\nconst folderExists=await checkFolderExists(accessToken,siteId,folderPath);if(!folderExists)await createFolder(accessToken,siteId,folderPath);// Hochladen\nconst uploadedUrls=[];const totalFiles=images.length;// Initialisierung entfernen wir hier, da sie gleich im Loop passiert\n// if (onProgress) onProgress(0, totalFiles); \nfor(let i=0;i<totalFiles;i++){// ÄNDERUNG: Progress VOR dem Upload aktualisieren\n// Damit steht da \"Uploading image 1 of 4\" während Bild 1 lädt\nif(onProgress){onProgress(i+1,totalFiles);}const img=images[i];console.log('Lade Bild hoch:',img.file.name);let url;if(img.file.size>4*1024*1024){url=await uploadLargeFile(accessToken,siteId,img.file,folderPath);}else{url=await uploadSmallFile(accessToken,siteId,img.file,folderPath);}console.log('Hochgeladene URL:',url);uploadedUrls.push(url);}// LOGGING HINZUFÜGEN\ntry{var _teams$find;const totalSizeMB=files.reduce((acc,file)=>acc+file.size,0)/(1024*1024);// Versuche Team-Namen zu finden oder nutze ID\nconst teamName=((_teams$find=teams.find(t=>t.id===post.teamId))===null||_teams$find===void 0?void 0:_teams$find.displayName)||post.teamId;await logToSharePoint(accessToken,{userEmail:account.username,// NEW: Log the specific subfolder in sourceUrl\nsourceUrl:\"Team: \".concat(teamName,\" / Channel: \").concat(post.channelDisplayName,\" / Folder: \").concat(post.subFolder||\"Root\",\" (Sync)\"),photoCount:files.length,totalSizeMB:parseFloat(totalSizeMB.toFixed(2)),targetTeamName:teamName,status:'Success'});}catch(logErr){console.error(\"Logging-Fehler:\",logErr);}//Mentions aus dem Post-Objekt holen\nconst mentions=post.mentions||[];// Posten - Jetzt mit files UND mentions\nawait postMessageToChannel(accessToken,post.teamId,post.channelId,post.text,uploadedUrls,files,mentions);await db.posts.delete(post.id);await db.images.where('postId').equals(post.id).delete();console.log('Post synced und gelöscht');}catch(err){console.error('Sync-Fehler für Post',post.id,':',err);}setPosting(false);};// ÄNDERUNG: Callback Signatur angepasst\nconst saveOfflinePost=async function(files){let subFolder=arguments.length>1&&arguments[1]!==undefined?arguments[1]:\"\";let onProgress=arguments.length>2?arguments[2]:undefined;// ÄNDERUNG: Erlaube leeren Text, wenn Dateien vorhanden sind\nif(!selectedTeam||!selectedChannel||!customText.trim()&&(!files||files.length===0))return;const post={teamId:selectedTeam.id,channelId:selectedChannel.id,channelDisplayName:selectedChannel.displayName,text:customText,imageUrls:[],timestamp:Date.now(),mentions:selectedMentions,// Mentions speichern\nsubFolder:subFolder// Subfolder speichern\n};const postId=await db.posts.add(post);if(files&&files.length>0){for(const file of files){await db.images.add({postId,file});}}const newPost=_objectSpread(_objectSpread({},post),{},{id:postId});setOfflinePosts([...offlinePosts,newPost]);// Neu: Wenn Online, sync nur diesen Post automatisch (ohne await)\nconst uploaded=isOnline&&account;if(uploaded){await syncPost(newPost,onProgress);}alert(\"\".concat((files===null||files===void 0?void 0:files.length)||0,\" image(s) saved \").concat(uploaded?'and uploaded':'offline',\"!\"));window.location.reload();// Seite neu laden, um State zu resetten\n// Reset alles\nsetCustomText('');setImageUrls([]);setSelectedChannel(null);setSelectedTeam(null);setUploadSuccess(false);setSelectedMentions([]);// Reset Mentions\n};const syncOfflinePosts=async()=>{if(!account||!isOnline||offlinePosts.length===0)return;setPosting(true);console.log('Starte Sync für',offlinePosts.length,'Posts');for(const post of offlinePosts){try{console.log('Sync Post:',post.id);const request=_objectSpread(_objectSpread({},loginRequest),{},{account});const response=await instance.acquireTokenSilent(request);const accessToken=response.accessToken;// Bilder aus Dexie laden\nconst images=await db.images.where('postId').equals(post.id).toArray();const files=images.map(img=>img.file);// HINWEIS: encodeFilesToBase64 entfernt\n// Ordner und Site-ID prüfen\nconst siteResponse=await fetch(\"https://graph.microsoft.com/v1.0/groups/\".concat(post.teamId,\"/sites/root\"),{headers:{Authorization:\"Bearer \".concat(accessToken)}});const siteData=await siteResponse.json();const siteId=siteData.id;console.log('Site ID:',siteId);// Bestimme den Ordner-Pfad\nlet folderPath=getFolderPath(post.channelDisplayName);// NEW: Append Subfolder if exists\nif(post.subFolder){folderPath=\"\".concat(folderPath,\"/\").concat(post.subFolder);}console.log('Verwende Ordner-Pfad:',folderPath);// Ordner prüfen/erstellen\nconst folderExists=await checkFolderExists(accessToken,siteId,folderPath);if(!folderExists)await createFolder(accessToken,siteId,folderPath);// Hochladen\nconst uploadedUrls=[];for(const img of images){console.log('Lade Bild hoch:',img.file.name);let url;if(img.file.size>4*1024*1024){url=await uploadLargeFile(accessToken,siteId,img.file,folderPath);}else{url=await uploadSmallFile(accessToken,siteId,img.file,folderPath);}console.log('Hochgeladene URL:',url);uploadedUrls.push(url);}// HIER: Mentions aus dem Post-Objekt holen\nconst mentions=post.mentions||[];// Posten - Jetzt mit files UND mentions\nawait postMessageToChannel(accessToken,post.teamId,post.channelId,post.text,uploadedUrls,files,mentions// <--- HIER übergeben\n);await db.posts.delete(post.id);await db.images.where('postId').equals(post.id).delete();console.log('Post synced und gelöscht');}catch(err){console.error('Sync-Fehler für Post',post.id,':',err);}}setOfflinePosts([]);setPosting(false);alert('Alle cached Posts hochgeladen!');};const handlePostToChannel=async()=>{// ÄNDERUNG: Erlaube leeren Text, wenn Bilder vorhanden sind\nif(!account||!selectedTeam||!selectedChannel||!customText&&imageUrls.length===0)return;setPosting(true);const request=_objectSpread(_objectSpread({},loginRequest),{},{account});try{const response=await instance.acquireTokenSilent(request);const accessToken=response.accessToken;// Hier uploadedFiles und selectedMentions übergeben\nawait postMessageToChannel(accessToken,selectedTeam.id,selectedChannel.id,customText,imageUrls,uploadedFiles,selectedMentions);alert(\"Beitrag erfolgreich in den Kanal gepostet!\");setUploadSuccess(false);setCustomText(\"\");setImageUrls([]);setUploadedFiles([]);setSelectedMentions([]);// Reset Mentions\n}catch(err){alert(\"Fehler beim Posten: \"+(err instanceof Error?err.message:\"Unbekannter Fehler\"));}finally{setPosting(false);}};if(loading&&account&&isOnline)return/*#__PURE__*/_jsx(Typography,{variant:\"h6\",children:\"Loading teams...\"});// Nur laden, wenn account und online\nif(error)return/*#__PURE__*/_jsxs(Alert,{severity:\"error\",children:[\"Error: \",error]});return/*#__PURE__*/_jsxs(Box,{sx:{mt:3},children:[(!isOnline||!account)&&/*#__PURE__*/_jsx(Alert,{severity:\"warning\",sx:{mb:2},children:!isOnline?'Offline-Modus: Eingaben werden lokal gespeichert.':'Nicht eingeloggt: Eingaben werden lokal gespeichert.'}),/*#__PURE__*/_jsxs(Typography,{variant:\"h5\",gutterBottom:true,children:[\"Team ausw\\xE4hlen (\",isOnline&&account?'Online':'Offline gecacht',\")\"]}),/*#__PURE__*/_jsx(Autocomplete,{options:availableTeams// Zeigt gecachte Teams, wenn nicht eingeloggt\n,getOptionLabel:option=>option.displayName,value:selectedTeam,onChange:handleTeamSelect,renderOption:(props,option)=>/*#__PURE__*/_jsxs(Box,_objectSpread(_objectSpread({component:\"li\"},props),{},{sx:{display:'flex',alignItems:'center'},children:[/*#__PURE__*/_jsx(IconButton,{size:\"small\",onClick:e=>{e.stopPropagation();toggleFavorite(option.id);},children:favorites.has(option.id)?/*#__PURE__*/_jsx(Star,{color:\"primary\"}):/*#__PURE__*/_jsx(StarBorder,{})}),option.displayName]})),renderInput:params=>/*#__PURE__*/_jsx(TextField,_objectSpread(_objectSpread({},params),{},{label:\"Search teams\",variant:\"outlined\"})),sx:{mb:2}}),selectedTeam&&/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsx(ChannelsList,{team:selectedTeam,onChannelSelect:setSelectedChannel,onUploadSuccess:(urls,files,base64Images)=>{setImageUrls(urls);setUploadSuccess(true);// Files speichern für den Post\nsetUploadedFiles(files||[]);},onCustomTextChange:setCustomText,customText:customText,isFavorite:favorites.has(selectedTeam.id),cachedChannels:((_cachedFavorites$find=cachedFavorites.find(f=>f.id===selectedTeam.id))===null||_cachedFavorites$find===void 0?void 0:_cachedFavorites$find.channels)||[]// FIX: Pass cachedSubFolders prop\n,cachedSubFolders:((_cachedFavorites$find2=cachedFavorites.find(f=>f.id===selectedTeam.id))===null||_cachedFavorites$find2===void 0?void 0:_cachedFavorites$find2.channelSubFolders)||{},onSaveOffline:saveOfflinePost}),isOnline&&/*#__PURE__*/_jsx(Autocomplete,{multiple:true,options:teamMembers,getOptionLabel:option=>option.displayName,value:selectedMentions,onChange:(event,newValue)=>{setSelectedMentions(newValue);},renderInput:params=>/*#__PURE__*/_jsx(TextField,_objectSpread(_objectSpread({},params),{},{label:\"Personen erw\\xE4hnen (@)\",placeholder:\"Namen eingeben...\",variant:\"outlined\"})),sx:{mt:2}})]}),uploadSuccess&&(customText.trim()||imageUrls.length>0)&&isOnline&&account&&/*#__PURE__*/_jsx(Button,{variant:\"contained\",color:\"primary\",onClick:handlePostToChannel,disabled:posting,sx:{mt:2},children:posting?\"Posting...\":\"Beitrag in Kanal posten\"}),offlinePosts.length>0&&isOnline&&account&&/*#__PURE__*/_jsxs(Button,{onClick:syncOfflinePosts,variant:\"contained\",sx:{mt:2},disabled:posting,children:[\"Upload (\",offlinePosts.length,\") cached post(s)\"]})]});};export default TeamsList;","map":{"version":3,"names":["React","useEffect","useState","useMemo","useMsal","useAccount","InteractionRequiredAuthError","loginRequest","db","logToSharePoint","ChannelsList","postMessageToChannel","Autocomplete","TextField","Button","Typography","Box","Alert","IconButton","Star","StarBorder","checkFolderExists","createFolder","uploadLargeFile","uploadSmallFile","getFolderPath","jsx","_jsx","jsxs","_jsxs","Fragment","_Fragment","TeamsList","_cachedFavorites$find","_cachedFavorites$find2","instance","accounts","account","teams","setTeams","loading","setLoading","error","setError","selectedTeam","setSelectedTeam","selectedChannel","setSelectedChannel","uploadSuccess","setUploadSuccess","customText","setCustomText","imageUrls","setImageUrls","posting","setPosting","favorites","setFavorites","Set","isOnline","setIsOnline","navigator","onLine","offlinePosts","setOfflinePosts","cachedFavorites","setCachedFavorites","uploadedFiles","setUploadedFiles","teamMembers","setTeamMembers","selectedMentions","setSelectedMentions","handleOnline","handleOffline","window","addEventListener","removeEventListener","sortedTeams","sort","a","b","aFav","has","id","bFav","displayName","localeCompare","loadCachedData","cached","favoriteTeams","toArray","posts","stored","localStorage","getItem","JSON","parse","fetchTeams","request","_objectSpread","response","acquireTokenSilent","accessToken","graphResponse","fetch","headers","Authorization","concat","ok","data","json","value","err","acquireTokenPopup","then","res","loadAndCacheDataForFavorites","size","favId","team","find","t","f","cachedFav","channels","members","channelSubFolders","needsUpdate","channelsResponse","channelsData","console","membersResponse","membersData","filter","m","userId","map","siteResponse","siteData","siteId","channel","folderPath","childrenResponse","subs","item","name","status","e","warn","newFavData","put","prev","idx","findIndex","newArr","toggleFavorite","teamId","newFavorites","delete","add","mData","favData","setItem","stringify","cachedTeam","length","log","isMounted","fetchMembersAPI","currentFav","get","updatedFav","handleTeamSelect","event","availableTeams","fav","syncPost","post","onProgress","images","where","equals","files","img","file","channelDisplayName","subFolder","folderExists","uploadedUrls","totalFiles","i","url","push","_teams$find","totalSizeMB","reduce","acc","teamName","userEmail","username","sourceUrl","photoCount","parseFloat","toFixed","targetTeamName","logErr","mentions","channelId","text","saveOfflinePost","arguments","undefined","trim","timestamp","Date","now","postId","newPost","uploaded","alert","location","reload","syncOfflinePosts","handlePostToChannel","Error","message","variant","children","severity","sx","mt","mb","gutterBottom","options","getOptionLabel","option","onChange","renderOption","props","component","display","alignItems","onClick","stopPropagation","color","renderInput","params","label","onChannelSelect","onUploadSuccess","urls","base64Images","onCustomTextChange","isFavorite","cachedChannels","cachedSubFolders","onSaveOffline","multiple","newValue","placeholder","disabled"],"sources":["/home/vsts/work/1/s/src/ui-components/TeamsList.tsx"],"sourcesContent":["import React, { useEffect, useState, useMemo } from \"react\";\nimport { useMsal, useAccount } from \"@azure/msal-react\";\nimport { InteractionRequiredAuthError } from \"@azure/msal-browser\";\nimport { loginRequest } from \"../authConfig\";\nimport { db, Team, Channel, SubFolder } from '../db'; // Import SubFolder\nimport { logToSharePoint } from \"../utils/Logger\";\nimport ChannelsList from \"./ChannelsList\";\nimport { postMessageToChannel, MentionUser } from \"./PostMessage\"; // MentionUser importieren\nimport { Autocomplete, TextField, Button, Typography, Box, Alert, IconButton } from \"@mui/material\";\nimport { Star, StarBorder } from \"@mui/icons-material\";\nimport { checkFolderExists, createFolder, uploadLargeFile, uploadSmallFile, encodeFilesToBase64, getFolderPath } from './ImageUpload';\n\nconst TeamsList: React.FC = () => {\n    const { instance, accounts } = useMsal();\n    const account = useAccount(accounts[0] || {});\n    const [teams, setTeams] = useState<Team[]>([]);\n    const [loading, setLoading] = useState<boolean>(true);\n    const [error, setError] = useState<string | null>(null);\n    const [selectedTeam, setSelectedTeam] = useState<Team | null>(null);\n    const [selectedChannel, setSelectedChannel] = useState<Channel | null>(null);\n    const [uploadSuccess, setUploadSuccess] = useState<boolean>(false);\n    const [customText, setCustomText] = useState<string>(\"\");\n    const [imageUrls, setImageUrls] = useState<string[]>([]);\n    const [posting, setPosting] = useState<boolean>(false);\n    const [favorites, setFavorites] = useState<Set<string>>(new Set());\n    const [isOnline, setIsOnline] = useState(navigator.onLine);\n    const [offlinePosts, setOfflinePosts] = useState<any[]>([]);\n    const [cachedFavorites, setCachedFavorites] = useState<any[]>([]);\n    const [uploadedFiles, setUploadedFiles] = useState<File[]>([]);\n    \n    // Neue States für Mentions\n    const [teamMembers, setTeamMembers] = useState<MentionUser[]>([]);\n    const [selectedMentions, setSelectedMentions] = useState<MentionUser[]>([]);\n\n    // Online-Status überwachen\n    useEffect(() => {\n        const handleOnline = () => setIsOnline(true);\n        const handleOffline = () => setIsOnline(false);\n        window.addEventListener('online', handleOnline);\n        window.addEventListener('offline', handleOffline);\n        return () => {\n            window.removeEventListener('online', handleOnline);\n            window.removeEventListener('offline', handleOffline);\n        };\n    }, []);\n\n     // Sortiere Teams: Favoriten zuerst\n    const sortedTeams = useMemo(() => {\n        return [...teams].sort((a, b) => {\n            const aFav = favorites.has(a.id);\n            const bFav = favorites.has(b.id);\n            if (aFav && !bFav) return -1;\n            if (!aFav && bFav) return 1;\n            return a.displayName.localeCompare(b.displayName);\n        });\n    }, [teams, favorites]);\n\n    // Lade gecachte Favoriten und Offline-Posts\n    useEffect(() => {\n        const loadCachedData = async () => {\n            const cached = await db.favoriteTeams.toArray();\n            setCachedFavorites(cached);\n            const posts = await db.posts.toArray();\n            setOfflinePosts(posts);\n        };\n        loadCachedData();\n    }, []);\n\n    useEffect(() => {\n        const stored = localStorage.getItem('favoriteTeams');\n        setFavorites(stored ? new Set(JSON.parse(stored)) : new Set());\n    }, []);\n\n    useEffect(() => {\n        const fetchTeams = async () => {\n            if (!account || !isOnline) {\n                setLoading(false);  // Setze loading auf false, wenn kein account oder offline\n                return;\n            }\n\n            const request = { ...loginRequest, account };\n\n            try {\n                const response = await instance.acquireTokenSilent(request);\n                const accessToken = response.accessToken;\n\n                const graphResponse = await fetch(\"https://graph.microsoft.com/v1.0/me/joinedTeams\", {\n                    headers: { Authorization: `Bearer ${accessToken}` },\n                });\n\n                if (graphResponse.ok) {\n                    const data = await graphResponse.json();\n                    setTeams(data.value);\n                } else {\n                    setError(\"Failed to fetch teams\");\n                }\n            } catch (err) {\n                if (err instanceof InteractionRequiredAuthError) {\n                    instance.acquireTokenPopup(request).then((response) => {\n                        const accessToken = response.accessToken;\n                        fetch(\"https://graph.microsoft.com/v1.0/me/joinedTeams\", {\n                            headers: { Authorization: `Bearer ${accessToken}` },\n                        }).then((res) => res.json()).then((data) => setTeams(data.value));\n                    });\n                } else {\n                    setError(\"Error fetching teams\");\n                }\n            } finally {\n                setLoading(false);\n            }\n        };\n\n        fetchTeams();\n        // Entferne loadAndCacheChannelsForFavorites aus useEffect, um Loop zu vermeiden\n    }, [instance, account, isOnline]);  // Entferne favorites aus dependencies, um Loop zu vermeiden\n\n    // Neuer useEffect für Kanäle, Mitglieder UND Subfolders Caching\n    useEffect(() => {\n        const loadAndCacheDataForFavorites = async () => {\n            if (!account || !isOnline || favorites.size === 0) return;\n            const request = { ...loginRequest, account };\n            const response = await instance.acquireTokenSilent(request);\n            const accessToken = response.accessToken;\n\n            for (const favId of favorites) {\n                const team = teams.find(t => t.id === favId) || cachedFavorites.find(f => f.id === favId);\n                const cachedFav = cachedFavorites.find(f => f.id === favId);\n                \n                if (team) {\n                    let channels = cachedFav?.channels;\n                    let members = cachedFav?.members;\n                    let channelSubFolders = cachedFav?.channelSubFolders || {}; // Load existing\n                    let needsUpdate = false;\n\n                    // 1. Kanäle laden falls fehlen\n                    if (!channels) {\n                        try {\n                            const channelsResponse = await fetch(`https://graph.microsoft.com/v1.0/teams/${favId}/channels`, {\n                                headers: { Authorization: `Bearer ${accessToken}` },\n                            });\n                            if (channelsResponse.ok) {\n                                const channelsData = await channelsResponse.json();\n                                channels = channelsData.value;\n                                needsUpdate = true;\n                            }\n                        } catch (err) {\n                            console.error(`Fehler beim Laden von Kanälen für ${favId}:`, err);\n                        }\n                    }\n\n                    // 2. Mitglieder laden falls fehlen (NEU)\n                    if (!members) {\n                        try {\n                            const membersResponse = await fetch(`https://graph.microsoft.com/v1.0/teams/${favId}/members`, {\n                                headers: { Authorization: `Bearer ${accessToken}` },\n                            });\n                            if (membersResponse.ok) {\n                                const membersData = await membersResponse.json();\n                                members = membersData.value\n                                    .filter((m: any) => m.userId)\n                                    .map((m: any) => ({\n                                        id: m.userId,\n                                        displayName: m.displayName\n                                    }));\n                                needsUpdate = true;\n                            }\n                        } catch (err) {\n                            console.error(`Fehler beim Laden von Mitgliedern für ${favId}:`, err);\n                        }\n                    }\n\n                    // 3. Subfolders für jeden Kanal laden (NEW)\n                    if (channels) {\n                        // Get Site ID first (needed for drive queries)\n                        try {\n                            const siteResponse = await fetch(`https://graph.microsoft.com/v1.0/groups/${favId}/sites/root`, {\n                                headers: { Authorization: `Bearer ${accessToken}` },\n                            });\n                            if (siteResponse.ok) {\n                                const siteData = await siteResponse.json();\n                                const siteId = siteData.id;\n\n                                for (const channel of channels) {\n                                    // Always try to update, or check if missing\n                                    // If we want to refresh cache, we should probably do it.\n                                    // For now, let's check if it's missing or empty\n                                    \n                                    const folderPath = getFolderPath(channel.displayName);\n                                    try {\n                                        const childrenResponse = await fetch(\n                                            `https://graph.microsoft.com/v1.0/sites/${siteId}/drive/root:/${folderPath}:/children?filter=folder ne null&select=id,name`, \n                                            { headers: { Authorization: `Bearer ${accessToken}` } }\n                                        );\n                                        \n                                        if (childrenResponse.ok) {\n                                            const data = await childrenResponse.json();\n                                            const subs = data.value.map((item: any) => ({ id: item.id, name: item.name }));\n                                            channelSubFolders[channel.id] = subs;\n                                            needsUpdate = true;\n                                        } else if (childrenResponse.status === 404) {\n                                            // Folder doesn't exist -> Empty list\n                                            channelSubFolders[channel.id] = [];\n                                            needsUpdate = true;\n                                        }\n                                    } catch (e) {\n                                        console.warn(`Could not fetch subfolders for channel ${channel.displayName}`, e);\n                                    }\n                                }\n                            }\n                        } catch (e) {\n                            console.error(\"Error fetching site ID for subfolders\", e);\n                        }\n                    }\n\n                    // Wenn Daten aktualisiert wurden, in DB speichern\n                    if (needsUpdate && channels) {\n                        const newFavData = { \n                            id: favId, \n                            displayName: team.displayName, \n                            channels: channels,\n                            members: members || [],\n                            channelSubFolders: channelSubFolders // Save subfolders\n                        };\n                        await db.favoriteTeams.put(newFavData);\n                        \n                        // State aktualisieren\n                        setCachedFavorites(prev => {\n                            const idx = prev.findIndex(f => f.id === favId);\n                            if (idx >= 0) {\n                                const newArr = [...prev];\n                                newArr[idx] = newFavData;\n                                return newArr;\n                            }\n                            return [...prev, newFavData];\n                        });\n                    }\n                }\n            }\n        };\n\n        loadAndCacheDataForFavorites();\n    }, [favorites, account, isOnline, teams]); // cachedFavorites aus Deps entfernt um Loop zu vermeiden\n\n    const toggleFavorite = async (teamId: string) => {\n        const newFavorites = new Set(favorites);\n        if (newFavorites.has(teamId)) {\n            newFavorites.delete(teamId);\n            await db.favoriteTeams.delete(teamId);  // Aus Cache entfernen\n        } else {\n            newFavorites.add(teamId);\n            // Cache Team, Kanäle und Mitglieder (nur online)\n            if (isOnline && account) {\n                const team = teams.find(t => t.id === teamId);\n                if (team) {\n                    const request = { ...loginRequest, account };\n                    const response = await instance.acquireTokenSilent(request);\n                    const accessToken = response.accessToken;\n                    \n                    // Kanäle laden\n                    const channelsResponse = await fetch(`https://graph.microsoft.com/v1.0/teams/${teamId}/channels`, {\n                        headers: { Authorization: `Bearer ${accessToken}` },\n                    });\n                    const channelsData = await channelsResponse.json();\n\n                    // Mitglieder laden (NEU)\n                    let members: MentionUser[] = [];\n                    try {\n                        const membersResponse = await fetch(`https://graph.microsoft.com/v1.0/teams/${teamId}/members`, {\n                            headers: { Authorization: `Bearer ${accessToken}` },\n                        });\n                        if (membersResponse.ok) {\n                            const mData = await membersResponse.json();\n                            members = mData.value.filter((m:any) => m.userId).map((m:any) => ({ id: m.userId, displayName: m.displayName }));\n                        }\n                    } catch (e) { console.error(\"Failed to fetch members for fav\", e); }\n\n                    const favData = { \n                        id: teamId, \n                        displayName: team.displayName, \n                        channels: channelsData.value,\n                        members: members\n                    };\n                    await db.favoriteTeams.put(favData);\n                    \n                    // Cache State sofort aktualisieren\n                    setCachedFavorites(prev => [...prev.filter(f => f.id !== teamId), favData]);\n                }\n            }\n        }\n        setFavorites(newFavorites);\n        localStorage.setItem('favoriteTeams', JSON.stringify([...newFavorites]));\n    };\n\n    // Mitglieder laden: Teil 1 - Aus Cache (reagiert auf Cache-Updates)\n    useEffect(() => {\n        if (!selectedTeam) {\n            setTeamMembers([]);\n            return;\n        }\n        \n        // Wir suchen im State 'cachedFavorites'\n        const cachedTeam = cachedFavorites.find(f => f.id === selectedTeam.id);\n        \n        // Prüfen ob Mitglieder im Cache sind\n        if (cachedTeam?.members && cachedTeam.members.length > 0) {\n            console.log(`Lade Mitglieder aus Cache für ${selectedTeam.displayName} (${cachedTeam.members.length} Mitglieder)`);\n            setTeamMembers(cachedTeam.members);\n        } else if (!isOnline) {\n            // Offline und kein Cache -> leer\n            console.warn(\"Offline und keine Mitglieder im Cache für dieses Team.\");\n            setTeamMembers([]);\n        }\n    }, [selectedTeam, cachedFavorites, isOnline]);\n\n    // Mitglieder laden: Teil 2 - Von API (reagiert NICHT auf cachedFavorites -> verhindert Loop)\n    useEffect(() => {\n        let isMounted = true;\n\n        const fetchMembersAPI = async () => {\n            if (!selectedTeam || !account || !isOnline) return;\n            \n            console.log(`Lade Mitglieder für Team (API): ${selectedTeam.displayName}`);\n\n            const request = { ...loginRequest, account };\n\n            try {\n                let accessToken;\n                try {\n                    const response = await instance.acquireTokenSilent(request);\n                    accessToken = response.accessToken;\n                } catch (err) {\n                    if (err instanceof InteractionRequiredAuthError) {\n                        return; \n                    }\n                    throw err;\n                }\n                \n                const res = await fetch(`https://graph.microsoft.com/v1.0/teams/${selectedTeam.id}/members`, {\n                    headers: { Authorization: `Bearer ${accessToken}` }\n                });\n                \n                if (res.ok) {\n                    const data = await res.json();\n                    if (isMounted) {\n                        const members = data.value\n                            .filter((m: any) => m.userId && m.displayName)\n                            .map((m: any) => ({\n                                id: m.userId,\n                                displayName: m.displayName\n                            }));\n                        \n                        setTeamMembers(members);\n\n                        // Cache aktualisieren, falls es ein Favorit ist\n                        if (favorites.has(selectedTeam.id)) {\n                             const currentFav = await db.favoriteTeams.get(selectedTeam.id);\n                             if (currentFav) {\n                                 const updatedFav = { ...currentFav, members };\n                                 await db.favoriteTeams.put(updatedFav);\n                                 // Dies triggert Effect 1, aber nicht diesen Effect 2!\n                                 setCachedFavorites(prev => prev.map(f => f.id === selectedTeam.id ? updatedFav : f));\n                             }\n                        }\n                    }\n                }\n            } catch (e) {\n                console.error(\"Fehler beim Laden der Mitglieder\", e);\n            }\n        };\n        \n        fetchMembersAPI();\n\n        return () => { isMounted = false; };\n    }, [selectedTeam, account, isOnline, instance, favorites]); // WICHTIG: cachedFavorites entfernt!\n\n    const handleTeamSelect = (event: any, value: Team | null) => {\n        setSelectedTeam(value);\n        setUploadSuccess(false);\n        setCustomText(\"\");\n        setImageUrls([]);\n        setUploadedFiles([]);\n        setSelectedMentions([]); // Reset Mentions\n    };\n\n    // Kombiniere online Teams mit gecachten Favoriten für Offline\n    const availableTeams = useMemo(() => {\n        if (isOnline && teams.length > 0) return sortedTeams;\n        return cachedFavorites.map(fav => ({ id: fav.id, displayName: fav.displayName }));  // Offline: Nur gecachte\n    }, [isOnline, teams, sortedTeams, cachedFavorites]);\n\n    // Füge syncPost Funktion hinzu (falls nicht vorhanden)\n    // ÄNDERUNG: Callback Signatur angepasst\n    const syncPost = async (post: any, onProgress?: (current: number, total: number) => void) => {\n        if (!account || !isOnline) return;\n        setPosting(true);\n        try {\n            console.log('Starte Sync für Post:', post.id);\n            const request = { ...loginRequest, account };\n            const response = await instance.acquireTokenSilent(request);\n            const accessToken = response.accessToken;\n\n            // Bilder aus Dexie laden\n            const images = await db.images.where('postId').equals(post.id).toArray();\n            const files = images.map(img => img.file);\n\n            // HINWEIS: encodeFilesToBase64 wird nicht mehr benötigt für den Post\n\n            // Ordner und Site-ID prüfen\n            const siteResponse = await fetch(`https://graph.microsoft.com/v1.0/groups/${post.teamId}/sites/root`, {\n                headers: { Authorization: `Bearer ${accessToken}` },\n            });\n            const siteData = await siteResponse.json();\n            const siteId = siteData.id;\n            console.log('Site ID:', siteId);\n\n            // Bestimme den Ordner-Pfad\n            let folderPath = getFolderPath(post.channelDisplayName);\n            // NEW: Append Subfolder if exists\n            if (post.subFolder) {\n                folderPath = `${folderPath}/${post.subFolder}`;\n            }\n            console.log('Verwende Ordner-Pfad:', folderPath);\n\n            // Ordner prüfen/erstellen\n            const folderExists = await checkFolderExists(accessToken, siteId, folderPath);\n            if (!folderExists) await createFolder(accessToken, siteId, folderPath);\n\n            // Hochladen\n            const uploadedUrls: string[] = [];\n            const totalFiles = images.length;\n\n            // Initialisierung entfernen wir hier, da sie gleich im Loop passiert\n            // if (onProgress) onProgress(0, totalFiles); \n\n            for (let i = 0; i < totalFiles; i++) {\n                // ÄNDERUNG: Progress VOR dem Upload aktualisieren\n                // Damit steht da \"Uploading image 1 of 4\" während Bild 1 lädt\n                if (onProgress) {\n                    onProgress(i + 1, totalFiles);\n                }\n\n                const img = images[i];\n                console.log('Lade Bild hoch:', img.file.name);\n                let url: string;\n                if (img.file.size > 4 * 1024 * 1024) {\n                    url = await uploadLargeFile(accessToken, siteId, img.file, folderPath);\n                } else {\n                    url = await uploadSmallFile(accessToken, siteId, img.file, folderPath);\n                }\n                console.log('Hochgeladene URL:', url);\n                uploadedUrls.push(url);\n            }\n\n            // LOGGING HINZUFÜGEN\n            try {\n                const totalSizeMB = files.reduce((acc, file) => acc + file.size, 0) / (1024 * 1024);\n                // Versuche Team-Namen zu finden oder nutze ID\n                const teamName = teams.find(t => t.id === post.teamId)?.displayName || post.teamId;\n                \n                await logToSharePoint(accessToken, {\n                    userEmail: account.username,\n                    // NEW: Log the specific subfolder in sourceUrl\n                    sourceUrl: `Team: ${teamName} / Channel: ${post.channelDisplayName} / Folder: ${post.subFolder || \"Root\"} (Sync)`,\n                    photoCount: files.length,\n                    totalSizeMB: parseFloat(totalSizeMB.toFixed(2)),\n                    targetTeamName: teamName,\n                    status: 'Success'\n                });\n            } catch (logErr) {\n                console.error(\"Logging-Fehler:\", logErr);\n            }\n            \n            //Mentions aus dem Post-Objekt holen\n            const mentions = post.mentions || [];\n\n            // Posten - Jetzt mit files UND mentions\n            await postMessageToChannel(\n                accessToken, \n                post.teamId, \n                post.channelId, \n                post.text, \n                uploadedUrls, \n                files, \n                mentions\n            );\n            \n            await db.posts.delete(post.id);\n            await db.images.where('postId').equals(post.id).delete();\n            console.log('Post synced und gelöscht');\n        } catch (err) {\n            console.error('Sync-Fehler für Post', post.id, ':', err);\n        }\n        setPosting(false);\n    };\n\n    // ÄNDERUNG: Callback Signatur angepasst\n    const saveOfflinePost = async (files?: File[], subFolder: string = \"\", onProgress?: (current: number, total: number) => void) => {\n        // ÄNDERUNG: Erlaube leeren Text, wenn Dateien vorhanden sind\n        if (!selectedTeam || !selectedChannel || (!customText.trim() && (!files || files.length === 0))) return;\n        const post = {\n            teamId: selectedTeam.id,\n            channelId: selectedChannel.id,\n            channelDisplayName: selectedChannel.displayName,\n            text: customText,\n            imageUrls: [] as string[],\n            timestamp: Date.now(),\n            mentions: selectedMentions, // Mentions speichern\n            subFolder: subFolder // Subfolder speichern\n        };\n        const postId = await db.posts.add(post);\n        if (files && files.length > 0) {\n            for (const file of files) {\n                await db.images.add({ postId, file });\n            }\n        }\n        const newPost = { ...post, id: postId };\n        setOfflinePosts([...offlinePosts, newPost]);\n\n        // Neu: Wenn Online, sync nur diesen Post automatisch (ohne await)\n        const uploaded = isOnline && account;\n        if (uploaded) {\n            await syncPost(newPost, onProgress);\n        }\n        alert(`${files?.length || 0} image(s) saved ${uploaded ? 'and uploaded' : 'offline'}!`);\n        window.location.reload();  // Seite neu laden, um State zu resetten\n        // Reset alles\n        setCustomText('');\n        setImageUrls([]);\n        setSelectedChannel(null);\n        setSelectedTeam(null);\n        setUploadSuccess(false);\n        setSelectedMentions([]); // Reset Mentions\n    };\n\n    const syncOfflinePosts = async () => {\n        if (!account || !isOnline || offlinePosts.length === 0) return;\n        setPosting(true);\n        console.log('Starte Sync für', offlinePosts.length, 'Posts');\n        for (const post of offlinePosts) {\n            try {\n                console.log('Sync Post:', post.id);\n                const request = { ...loginRequest, account };\n                const response = await instance.acquireTokenSilent(request);\n                const accessToken = response.accessToken;\n\n                // Bilder aus Dexie laden\n                const images = await db.images.where('postId').equals(post.id).toArray();\n                const files = images.map(img => img.file);\n\n                // HINWEIS: encodeFilesToBase64 entfernt\n\n                // Ordner und Site-ID prüfen\n                const siteResponse = await fetch(`https://graph.microsoft.com/v1.0/groups/${post.teamId}/sites/root`, {\n                    headers: { Authorization: `Bearer ${accessToken}` },\n                });\n                const siteData = await siteResponse.json();\n                const siteId = siteData.id;\n                console.log('Site ID:', siteId);\n\n                // Bestimme den Ordner-Pfad\n                let folderPath = getFolderPath(post.channelDisplayName);\n                // NEW: Append Subfolder if exists\n                if (post.subFolder) {\n                    folderPath = `${folderPath}/${post.subFolder}`;\n                }\n                console.log('Verwende Ordner-Pfad:', folderPath);\n\n                // Ordner prüfen/erstellen\n                const folderExists = await checkFolderExists(accessToken, siteId, folderPath);\n                if (!folderExists) await createFolder(accessToken, siteId, folderPath);\n\n                // Hochladen\n                const uploadedUrls: string[] = [];\n                for (const img of images) {\n                    console.log('Lade Bild hoch:', img.file.name);\n                    let url: string;\n                    if (img.file.size > 4 * 1024 * 1024) {\n                        url = await uploadLargeFile(accessToken, siteId, img.file, folderPath);\n                    } else {\n                        url = await uploadSmallFile(accessToken, siteId, img.file, folderPath);\n                    }\n                    console.log('Hochgeladene URL:', url);\n                    uploadedUrls.push(url);\n                }\n\n                // HIER: Mentions aus dem Post-Objekt holen\n                const mentions = post.mentions || [];\n\n                // Posten - Jetzt mit files UND mentions\n                await postMessageToChannel(\n                    accessToken, \n                    post.teamId, \n                    post.channelId, \n                    post.text, \n                    uploadedUrls, \n                    files, \n                    mentions // <--- HIER übergeben\n                );\n                \n                await db.posts.delete(post.id);\n                await db.images.where('postId').equals(post.id).delete();\n                console.log('Post synced und gelöscht');\n            } catch (err) {\n                console.error('Sync-Fehler für Post', post.id, ':', err);\n            }\n        }\n        setOfflinePosts([]);\n        setPosting(false);\n        alert('Alle cached Posts hochgeladen!');\n    };\n\n    const handlePostToChannel = async () => {\n        // ÄNDERUNG: Erlaube leeren Text, wenn Bilder vorhanden sind\n        if (!account || !selectedTeam || !selectedChannel || (!customText && imageUrls.length === 0)) return;\n\n        setPosting(true);\n\n        const request = { ...loginRequest, account };\n\n        try {\n            const response = await instance.acquireTokenSilent(request);\n            const accessToken = response.accessToken;\n\n            // Hier uploadedFiles und selectedMentions übergeben\n            await postMessageToChannel(accessToken, selectedTeam.id, selectedChannel!.id, customText, imageUrls, uploadedFiles, selectedMentions);\n\n            alert(\"Beitrag erfolgreich in den Kanal gepostet!\");\n            setUploadSuccess(false);\n            setCustomText(\"\");\n            setImageUrls([]);\n            setUploadedFiles([]);\n            setSelectedMentions([]); // Reset Mentions\n        } catch (err) {\n            alert(\"Fehler beim Posten: \" + (err instanceof Error ? err.message : \"Unbekannter Fehler\"));\n        } finally {\n            setPosting(false);\n        }\n    };\n\n   \n\n    if (loading && account && isOnline) return <Typography variant=\"h6\">Loading teams...</Typography>;  // Nur laden, wenn account und online\n    if (error) return <Alert severity=\"error\">Error: {error}</Alert>;\n\n    return (\n        <Box sx={{ mt: 3 }}>\n            {/* Offline-Hinweis */}\n            {(!isOnline || !account) && (\n                <Alert severity=\"warning\" sx={{ mb: 2 }}>\n                    {!isOnline ? 'Offline-Modus: Eingaben werden lokal gespeichert.' : 'Nicht eingeloggt: Eingaben werden lokal gespeichert.'}\n                </Alert>\n            )}\n\n            <Typography variant=\"h5\" gutterBottom>\n                Team auswählen ({isOnline && account ? 'Online' : 'Offline gecacht'})\n            </Typography>\n            <Autocomplete\n                options={availableTeams}  // Zeigt gecachte Teams, wenn nicht eingeloggt\n                getOptionLabel={(option) => option.displayName}\n                value={selectedTeam}\n                onChange={handleTeamSelect}\n                renderOption={(props, option) => (\n                    <Box component=\"li\" {...props} sx={{ display: 'flex', alignItems: 'center' }}>\n                        <IconButton size=\"small\" onClick={(e) => { e.stopPropagation(); toggleFavorite(option.id); }}>\n                            {favorites.has(option.id) ? <Star color=\"primary\" /> : <StarBorder />}\n                        </IconButton>\n                        {option.displayName}\n                    </Box>\n                )}\n                renderInput={(params) => <TextField {...params} label=\"Search teams\" variant=\"outlined\" />}\n                sx={{ mb: 2 }}\n            />\n            {selectedTeam && (\n                <>\n                    <ChannelsList\n                        team={selectedTeam}\n                        onChannelSelect={setSelectedChannel}\n                        onUploadSuccess={(urls: string[], files?: File[], base64Images?: string[]) => {\n                            setImageUrls(urls);\n                            setUploadSuccess(true);\n                            // Files speichern für den Post\n                            setUploadedFiles(files || []);\n                        }}\n                        onCustomTextChange={setCustomText}\n                        customText={customText}\n                        isFavorite={favorites.has(selectedTeam.id)}\n                        cachedChannels={cachedFavorites.find(f => f.id === selectedTeam.id)?.channels || []}\n                        // FIX: Pass cachedSubFolders prop\n                        cachedSubFolders={cachedFavorites.find(f => f.id === selectedTeam.id)?.channelSubFolders || {}}\n                        onSaveOffline={saveOfflinePost}\n                    />\n                    \n                    {/* UI für Mentions hinzufügen */}\n                    {isOnline && (\n                        <Autocomplete\n                            multiple\n                            options={teamMembers}\n                            getOptionLabel={(option) => option.displayName}\n                            value={selectedMentions}\n                            onChange={(event, newValue) => {\n                                setSelectedMentions(newValue);\n                            }}\n                            renderInput={(params) => (\n                                <TextField \n                                    {...params} \n                                    label=\"Personen erwähnen (@)\" \n                                    placeholder=\"Namen eingeben...\" \n                                    variant=\"outlined\"\n                                />\n                            )}\n                            sx={{ mt: 2 }}\n                        />\n                    )}\n                </>\n            )}\n            {/* ÄNDERUNG: Button anzeigen auch ohne Text, wenn Upload erfolgreich war */}\n            {uploadSuccess && (customText.trim() || imageUrls.length > 0) && isOnline && account && (\n                <Button\n                    variant=\"contained\"\n                    color=\"primary\"\n                    onClick={handlePostToChannel}\n                    disabled={posting}\n                    sx={{ mt: 2 }}\n                >\n                    {posting ? \"Posting...\" : \"Beitrag in Kanal posten\"}\n                </Button>\n            )}\n            {/* Sync-Button immer anzeigen, wenn Posts vorhanden und online/account */}\n            {offlinePosts.length > 0 && isOnline && account && (\n                <Button onClick={syncOfflinePosts} variant=\"contained\" sx={{ mt: 2 }} disabled={posting}>\n                    Upload ({offlinePosts.length}) cached post(s)\n                </Button>\n            )}\n        </Box>\n    );\n};\n\nexport default TeamsList;"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}