{"ast":null,"code":"import _objectSpread from\"/home/vsts/work/1/s/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";// filepath: /workspaces/redIT_Baumgartner_BildUpload/src/ui-components/ImageUpload.tsx\nimport React,{useState,useRef,useEffect}from\"react\";// Added useEffect\nimport{useMsal,useAccount}from\"@azure/msal-react\";import{InteractionRequiredAuthError}from\"@azure/msal-browser\";import{loginRequest}from\"../authConfig\";// Added Select, MenuItem, FormControl, InputLabel\nimport{TextField,Button,Typography,Box,Alert,Paper,Grid,IconButton,Card,CardMedia,CardContent,Select,MenuItem,FormControl,InputLabel}from\"@mui/material\";import{Delete as DeleteIcon}from\"@mui/icons-material\";import{logToSharePoint}from\"../utils/Logger\";import{UploadProgress}from\"./UploadProgress\";// Import shared interface\nimport{jsx as _jsx,jsxs as _jsxs}from\"react/jsx-runtime\";// Hilfsfunktion: Base64 zu Blob\nconst dataURLToBlob=dataURL=>{const arr=dataURL.split(',');const mime=arr[0].match(/:(.*?);/)[1];const bstr=atob(arr[1]);let n=bstr.length;const u8arr=new Uint8Array(n);while(n--){u8arr[n]=bstr.charCodeAt(n);}return new Blob([u8arr],{type:mime});};// Neue Hilfsfunktion: Prüfe, ob \"General\"-Kanal existiert und gib den Pfad zurück\nexport const getFolderPath=channelDisplayName=>{return\"\".concat(channelDisplayName,\"/Bilder\");// Direkt im Kanal\n};// Hilfsfunktionen außerhalb der Komponente definieren\nexport const checkFolderExists=async(accessToken,siteId,folderPath)=>{const checkResponse=await fetch(\"https://graph.microsoft.com/v1.0/sites/\".concat(siteId,\"/drive/root:/\").concat(folderPath),{headers:{Authorization:\"Bearer \".concat(accessToken)}});return checkResponse.ok;};export const createFolder=async(accessToken,siteId,folderPath)=>{const parentPath=folderPath.substring(0,folderPath.lastIndexOf('/'));// z.B. \"Shared Documents/General\"\nconst folderName=folderPath.split('/').pop();// z.B. \"Bilder\nconst createResponse=await fetch(\"https://graph.microsoft.com/v1.0/sites/\".concat(siteId,\"/drive/root:/\").concat(parentPath,\":/children\"),{method:\"POST\",headers:{Authorization:\"Bearer \".concat(accessToken),\"Content-Type\":\"application/json\"},body:JSON.stringify({name:folderName,folder:{},\"@microsoft.graph.conflictBehavior\":\"rename\"})});if(!createResponse.ok){throw new Error(\"Failed to create \".concat(folderName,\" folder\"));}};export const uploadLargeFile=async(accessToken,siteId,file,folderPath)=>{const filePath=\"\".concat(folderPath,\"/\").concat(file.name);// Erstelle Upload-Session\nconst sessionResponse=await fetch(\"https://graph.microsoft.com/v1.0/sites/\".concat(siteId,\"/drive/root:/\").concat(filePath,\":/createUploadSession\"),{method:\"POST\",headers:{Authorization:\"Bearer \".concat(accessToken),\"Content-Type\":\"application/json\"}});if(!sessionResponse.ok){throw new Error(\"Failed to create upload session for \".concat(file.name));}const sessionData=await sessionResponse.json();const uploadUrl=sessionData.uploadUrl;// Lade in Chunks hoch (320KB Chunks)\nconst chunkSize=327680;// 320KB\nlet uploadedBytes=0;while(uploadedBytes<file.size){const chunk=file.slice(uploadedBytes,uploadedBytes+chunkSize);const endByte=Math.min(uploadedBytes+chunk.size-1,file.size-1);const uploadResponse=await fetch(uploadUrl,{method:\"PUT\",headers:{\"Content-Length\":chunk.size.toString(),\"Content-Range\":\"bytes \".concat(uploadedBytes,\"-\").concat(endByte,\"/\").concat(file.size)},body:chunk});if(!uploadResponse.ok){throw new Error(\"Failed to upload chunk for \".concat(file.name));}uploadedBytes+=chunk.size;}// Gib die Web-URL der hochgeladenen Datei zurück\nconst finalResponse=await fetch(\"https://graph.microsoft.com/v1.0/sites/\".concat(siteId,\"/drive/root:/\").concat(filePath),{headers:{Authorization:\"Bearer \".concat(accessToken)}});const finalData=await finalResponse.json();return finalData.webUrl;};export const uploadSmallFile=async(accessToken,siteId,file,folderPath)=>{const uploadResponse=await fetch(\"https://graph.microsoft.com/v1.0/sites/\".concat(siteId,\"/drive/root:/\").concat(folderPath,\"/\").concat(file.name,\":/content\"),{method:\"PUT\",headers:{Authorization:\"Bearer \".concat(accessToken),\"Content-Type\":file.type},body:file});if(!uploadResponse.ok){const errorText=await uploadResponse.text();throw new Error(\"Failed to upload \".concat(file.name,\": \").concat(uploadResponse.status,\" \").concat(errorText));}// Hole die Web-URL\nconst urlResponse=await fetch(\"https://graph.microsoft.com/v1.0/sites/\".concat(siteId,\"/drive/root:/\").concat(folderPath,\"/\").concat(file.name),{headers:{Authorization:\"Bearer \".concat(accessToken)}});const urlData=await urlResponse.json();return urlData.webUrl;};// Neue Hilfsfunktion: Bild skalieren und zu base64 encodieren\n// Exportieren, damit andere Komponenten sie nutzen können\nexport const resizeImage=function(file){let maxWidth=arguments.length>1&&arguments[1]!==undefined?arguments[1]:200;let maxHeight=arguments.length>2&&arguments[2]!==undefined?arguments[2]:200;let quality=arguments.length>3&&arguments[3]!==undefined?arguments[3]:0.8;return new Promise((resolve,reject)=>{const img=new Image();img.onload=()=>{const canvas=document.createElement('canvas');const ctx=canvas.getContext('2d');// Berechne neue Größe, behalte Aspect Ratio\nlet{width,height}=img;if(width>height){if(width>maxWidth){height=height*maxWidth/width;width=maxWidth;}}else{if(height>maxHeight){width=width*maxHeight/height;height=maxHeight;}}canvas.width=width;canvas.height=height;ctx.drawImage(img,0,0,width,height);// Zu base64 konvertieren (JPEG für kleinere Größe)\ncanvas.toBlob(blob=>{if(blob){const reader=new FileReader();reader.onload=()=>resolve(reader.result);reader.onerror=reject;reader.readAsDataURL(blob);}else{reject(new Error('Canvas toBlob failed'));}},'image/jpeg',quality);// Verwende quality\n};img.onerror=reject;img.src=URL.createObjectURL(file);});};// Neue Hilfsfunktion: Mehrere Dateien zu base64 encodieren\nexport const encodeFilesToBase64=async files=>{// Kein Limit mehr – alle Bilder erlauben\nlet base64Images=await Promise.all(files.map(file=>resizeImage(file,150,150,0.4)));// Start mit 40% Qualität\nlet totalSize=base64Images.reduce((sum,img)=>sum+img.length*0.75,0);// Reduziere Qualität weiter, wenn über 24 KB\nlet quality=0.4;while(totalSize>24000&&quality>0.1){quality-=0.05;// Kleinere Schritte für feinere Anpassung\nbase64Images=await Promise.all(files.map(file=>resizeImage(file,150,150,quality)));totalSize=base64Images.reduce((sum,img)=>sum+img.length*0.75,0);}return base64Images;};const ImageUpload=_ref=>{let{team,channel,onUploadSuccess,onCustomTextChange,customText,onSaveOffline,cachedSubFolders=[],// Default empty\ninitialSelectedSubFolder=\"\"// New prop for testing\n}=_ref;const{instance,accounts}=useMsal();const account=useAccount(accounts[0]||{});const[selectedFiles,setSelectedFiles]=useState([]);const[uploading,setUploading]=useState(false);const[progressData,setProgressData]=useState({current:0,total:0,percent:0});const[error,setError]=useState(null);const[success,setSuccess]=useState(null);const[thumbnails,setThumbnails]=useState([]);// NEW: State for Subfolders\nconst[subFolders,setSubFolders]=useState([]);const[selectedSubFolder,setSelectedSubFolder]=useState(initialSelectedSubFolder);// Use initial value\nconst[loadingFolders,setLoadingFolders]=useState(false);const fileInputRef=useRef(null);const isOnline=navigator.onLine;// NEW: Fetch Subfolders when Channel changes\nuseEffect(()=>{const fetchSubFolders=async()=>{setSubFolders([]);// Removed setSelectedSubFolder(\"\"); to keep initial value\n// Offline or no account: Use cached subfolders\nif(!account||!isOnline){if(cachedSubFolders&&cachedSubFolders.length>0){setSubFolders(cachedSubFolders);}else{setSubFolders([]);}setLoadingFolders(false);return;}setLoadingFolders(true);const request=_objectSpread(_objectSpread({},loginRequest),{},{account});try{const response=await instance.acquireTokenSilent(request);const accessToken=response.accessToken;// 1. Get Site ID\nconst siteResponse=await fetch(\"https://graph.microsoft.com/v1.0/groups/\".concat(team.id,\"/sites/root\"),{headers:{Authorization:\"Bearer \".concat(accessToken)}});if(!siteResponse.ok)throw new Error(\"Failed to get site ID\");const siteData=await siteResponse.json();const siteId=siteData.id;// 2. Get Path to \"Bilder\"\nconst folderPath=getFolderPath(channel.displayName);// e.g., \"General/Bilder\"\n// 3. List Children of \"Bilder\"\nconst childrenResponse=await fetch(\"https://graph.microsoft.com/v1.0/sites/\".concat(siteId,\"/drive/root:/\").concat(folderPath,\":/children?filter=folder ne null&select=id,name\"),{headers:{Authorization:\"Bearer \".concat(accessToken)}});if(childrenResponse.ok){const data=await childrenResponse.json();setSubFolders(data.value.map(item=>({id:item.id,name:item.name})));}else if(childrenResponse.status===404){// \"Bilder\" folder doesn't exist yet, which is fine.\nconsole.log(\"Bilder folder does not exist yet.\");setSubFolders([]);// Explicitly set to empty\n}}catch(err){console.error(\"Error fetching subfolders:\",err);setSubFolders([]);// Set to empty on error\n}finally{setLoadingFolders(false);}};fetchSubFolders();},[team.id,channel.displayName,account,isOnline,instance,cachedSubFolders]);// Add cachedSubFolders to deps\nconst handleFileChange=event=>{if(event.target.files&&event.target.files.length>0){const newFiles=Array.from(event.target.files);setSelectedFiles(prev=>[...prev,...newFiles]);// Erzeuge Thumbnails für Vorschau (klein und schnell)\nconst generateThumbnails=async()=>{const newThumbnails=await Promise.all(newFiles.map(file=>resizeImage(file,100,100,0.5)));// Kleine Thumbnails\nsetThumbnails(prev=>[...prev,...newThumbnails]);};generateThumbnails();event.target.value=\"\";// Reset input\n}};const handleFileSelect=()=>{var _fileInputRef$current;(_fileInputRef$current=fileInputRef.current)===null||_fileInputRef$current===void 0?void 0:_fileInputRef$current.click();};const handleRemoveFile=index=>{setSelectedFiles(prev=>prev.filter((_,i)=>i!==index));};const handleRemoveSelection=()=>{setSelectedFiles([]);setThumbnails([]);// Thumbnails zurücksetzen\nif(fileInputRef.current){fileInputRef.current.value=\"\";}};const uploadImages=async()=>{if(!account||selectedFiles.length===0)return;setUploading(true);setError(null);setSuccess(null);const request=_objectSpread(_objectSpread({},loginRequest),{},{account});try{const response=await instance.acquireTokenSilent(request);const accessToken=response.accessToken;// Schritt 1: Hole SharePoint Site-ID\nconst siteResponse=await fetch(\"https://graph.microsoft.com/v1.0/groups/\".concat(team.id,\"/sites/root\"),{headers:{Authorization:\"Bearer \".concat(accessToken)}});if(!siteResponse.ok)throw new Error(\"Failed to get site ID\");const siteData=await siteResponse.json();const siteId=siteData.id;// Schritt 2: Bestimme den Ordner-Pfad\nlet folderPath=getFolderPath(channel.displayName);// NEW: Append Subfolder if selected\nif(selectedSubFolder){folderPath=\"\".concat(folderPath,\"/\").concat(selectedSubFolder);}console.log('Verwende Ordner-Pfad:',folderPath);// Schritt 3: Überprüfe und erstelle den Ordner\n// Note: If subfolder is selected, we assume it exists (as per requirement), \n// but checkFolderExists/createFolder handles the recursive creation if needed or we can rely on it existing.\n// The current createFolder implementation might fail if parent doesn't exist, \n// but since \"Bilder\" is parent and we check it, it should be fine.\nconst folderExists=await checkFolderExists(accessToken,siteId,folderPath);if(!folderExists){await createFolder(accessToken,siteId,folderPath);}// Schritt 4: Lade Bilder hoch\nconst imageUrls=[];for(const file of selectedFiles){let url;if(file.size>4*1024*1024){url=await uploadLargeFile(accessToken,siteId,file,folderPath);}else{url=await uploadSmallFile(accessToken,siteId,file,folderPath);}imageUrls.push(url);}// LOGGING HINZUFÜGEN\ntry{const totalSizeMB=selectedFiles.reduce((acc,file)=>acc+file.size,0)/(1024*1024);await logToSharePoint(accessToken,{userEmail:account.username,// NEW: Log the specific subfolder in sourceUrl\nsourceUrl:\"Team: \".concat(team.displayName,\" / Channel: \").concat(channel.displayName,\" / Folder: \").concat(selectedSubFolder||\"Root\"),photoCount:selectedFiles.length,totalSizeMB:parseFloat(totalSizeMB.toFixed(2)),targetTeamName:team.displayName,status:'Success'});}catch(logErr){console.error(\"Logging failed but upload was successful\",logErr);}// Schritt 5: Encodiere alle Bilder\nconst base64Images=await encodeFilesToBase64(selectedFiles);// Schritt 6: Erfolgreich hochgeladen - Callback aufrufen\nonUploadSuccess(imageUrls,selectedFiles,base64Images);// base64Images übergeben\nsetSuccess(\"\".concat(selectedFiles.length,\" image(s) uploaded successfully!\"));}catch(err){// LOGGING ERROR (Optional, aber hilfreich)\nif(account){// Wir versuchen einen Error-Log zu senden, falls möglich (braucht Token)\n// Da wir hier im catch sind, ist accessToken evtl. nicht verfügbar, \n// daher lassen wir es hier weg um \"minimal\" zu bleiben und keine neuen Fehler zu riskieren.\n}if(err instanceof InteractionRequiredAuthError){instance.acquireTokenPopup(request).then(uploadImages);}else{setError(err instanceof Error?err.message:\"Upload failed\");}}finally{setUploading(false);}};const handleUpload=async()=>{if(isOnline&&account){if(onSaveOffline){setUploading(true);setProgressData({current:0,total:selectedFiles.length,percent:0});try{// Callback aktualisiert jetzt current und total\n// Pass selectedSubFolder\nawait onSaveOffline(selectedFiles,selectedSubFolder,(current,total)=>{// ÄNDERUNG: Prozentsatz basierend auf abgeschlossenen Bildern (current - 1)\n// Beispiel bei 4 Bildern:\n// Bild 1 startet -> (0/4)*100 = 0%\n// Bild 2 startet -> (1/4)*100 = 25%\nconst percent=Math.round((current-1)/total*100);setProgressData({current,total,percent});});}catch(e){console.error(e);setUploading(false);}}else{await uploadImages();}}else{// Offline: Speichere lokal\nif(onSaveOffline){// Pass selectedSubFolder\nawait onSaveOffline(selectedFiles,selectedSubFolder);}setSuccess(\"\".concat(selectedFiles.length,\" image(s) saved offline!\"));setSelectedFiles([]);}};return/*#__PURE__*/_jsxs(Paper,{elevation:1,sx:{p:2,mt:2},children:[/*#__PURE__*/_jsx(Typography,{variant:\"h6\",gutterBottom:true,children:\"Bilder hochladen in Ordner \\\"Bilder\\\"\"}),(isOnline||subFolders.length>0)&&/*#__PURE__*/_jsxs(FormControl,{fullWidth:true,variant:\"outlined\",sx:{mb:2},disabled:loadingFolders||subFolders.length===0&&!isOnline,children:[/*#__PURE__*/_jsx(InputLabel,{id:\"subfolder-select-label\",children:\"Unterordner ausw\\xE4hlen (Optional)\"}),/*#__PURE__*/_jsxs(Select,{labelId:\"subfolder-select-label\",value:selectedSubFolder,onChange:e=>setSelectedSubFolder(e.target.value),label:\"Unterordner ausw\\xE4hlen (Optional)\",children:[/*#__PURE__*/_jsx(MenuItem,{value:\"\",children:/*#__PURE__*/_jsx(\"em\",{children:\"Kein Unterordner (Direkt in \\\"Bilder\\\")\"})}),subFolders.map(folder=>/*#__PURE__*/_jsx(MenuItem,{value:folder.name,children:folder.name},folder.id))]}),subFolders.length===0&&!loadingFolders&&/*#__PURE__*/_jsx(Typography,{variant:\"caption\",color:\"textSecondary\",sx:{ml:1,mt:0.5},children:isOnline?\"Keine Unterordner gefunden.\":\"Keine gecachten Unterordner verfügbar.\"})]}),/*#__PURE__*/_jsx(\"input\",{type:\"file\",accept:\"image/*\",multiple:true,onChange:handleFileChange,ref:fileInputRef,style:{display:'none'}}),/*#__PURE__*/_jsxs(Box,{sx:{display:'flex',alignItems:'center',mb:2},children:[/*#__PURE__*/_jsx(Button,{variant:\"outlined\",color:\"primary\",onClick:handleFileSelect,sx:{flexGrow:1,mr:1},children:selectedFiles.length>0?\"\".concat(selectedFiles.length,\" Datei(en) ausgew\\xE4hlt\"):\"Dateien auswählen\"}),selectedFiles.length>0&&/*#__PURE__*/_jsx(IconButton,{color:\"error\",onClick:handleRemoveSelection,title:\"Alle entfernen\",children:/*#__PURE__*/_jsx(DeleteIcon,{})})]}),selectedFiles.length>0&&/*#__PURE__*/_jsx(Box,{sx:{mb:2},children:/*#__PURE__*/_jsx(Grid,{container:true,spacing:2,children:selectedFiles.map((file,index)=>/*#__PURE__*/_jsx(Grid,{item:true,xs:6,sm:4,md:3,children:/*#__PURE__*/_jsxs(Card,{children:[/*#__PURE__*/_jsxs(Box,{sx:{position:'relative'},children:[/*#__PURE__*/_jsx(CardMedia,{component:\"img\",height:\"100\"// Kleiner für Performance\n,image:thumbnails[index]||''// Verwende thumbnail\n,alt:file.name,sx:{objectFit:'cover'}}),/*#__PURE__*/_jsx(IconButton,{size:\"small\",color:\"error\",onClick:()=>handleRemoveFile(index),sx:{position:'absolute',top:8,right:8,backgroundColor:'rgba(255, 255, 255, 0.8)','&:hover':{backgroundColor:'rgba(255, 255, 255, 1)'}},title:\"Entfernen\",children:/*#__PURE__*/_jsx(DeleteIcon,{fontSize:\"small\"})})]}),/*#__PURE__*/_jsxs(CardContent,{sx:{p:1},children:[/*#__PURE__*/_jsx(Typography,{variant:\"body2\",noWrap:true,children:file.name}),/*#__PURE__*/_jsxs(Typography,{variant:\"caption\",color:\"text.secondary\",children:[(file.size/1024/1024).toFixed(2),\" MB\"]})]})]})},index))})}),selectedFiles.length>0&&/*#__PURE__*/_jsx(TextField,{fullWidth:true,label:\"Nachricht zum Beitrag hinzuf\\xFCgen\",value:customText,onChange:e=>onCustomTextChange(e.target.value),variant:\"outlined\",sx:{mb:2}}),/*#__PURE__*/_jsx(UploadProgress,{uploading:uploading,progress:progressData.percent,currentFile:progressData.current,totalFiles:progressData.total}),/*#__PURE__*/_jsx(Button,{variant:\"contained\",color:\"secondary\",onClick:handleUpload,disabled:!selectedFiles.length||uploading||!isOnline&&!customText.trim(),fullWidth:true,sx:{mb:2},children:uploading?\"Uploading (\".concat(progressData.current,\"/\").concat(progressData.total,\")...\"):isOnline?\"Datei(en) hochladen\":\"Offline speichern\"}),error&&/*#__PURE__*/_jsxs(Alert,{severity:\"error\",sx:{mt:2},children:[\"Error: \",error]}),success&&/*#__PURE__*/_jsx(Alert,{severity:\"success\",sx:{mt:2},children:success})]});};export default ImageUpload;","map":{"version":3,"names":["React","useState","useRef","useEffect","useMsal","useAccount","InteractionRequiredAuthError","loginRequest","TextField","Button","Typography","Box","Alert","Paper","Grid","IconButton","Card","CardMedia","CardContent","Select","MenuItem","FormControl","InputLabel","Delete","DeleteIcon","logToSharePoint","UploadProgress","jsx","_jsx","jsxs","_jsxs","dataURLToBlob","dataURL","arr","split","mime","match","bstr","atob","n","length","u8arr","Uint8Array","charCodeAt","Blob","type","getFolderPath","channelDisplayName","concat","checkFolderExists","accessToken","siteId","folderPath","checkResponse","fetch","headers","Authorization","ok","createFolder","parentPath","substring","lastIndexOf","folderName","pop","createResponse","method","body","JSON","stringify","name","folder","Error","uploadLargeFile","file","filePath","sessionResponse","sessionData","json","uploadUrl","chunkSize","uploadedBytes","size","chunk","slice","endByte","Math","min","uploadResponse","toString","finalResponse","finalData","webUrl","uploadSmallFile","errorText","text","status","urlResponse","urlData","resizeImage","maxWidth","arguments","undefined","maxHeight","quality","Promise","resolve","reject","img","Image","onload","canvas","document","createElement","ctx","getContext","width","height","drawImage","toBlob","blob","reader","FileReader","result","onerror","readAsDataURL","src","URL","createObjectURL","encodeFilesToBase64","files","base64Images","all","map","totalSize","reduce","sum","ImageUpload","_ref","team","channel","onUploadSuccess","onCustomTextChange","customText","onSaveOffline","cachedSubFolders","initialSelectedSubFolder","instance","accounts","account","selectedFiles","setSelectedFiles","uploading","setUploading","progressData","setProgressData","current","total","percent","error","setError","success","setSuccess","thumbnails","setThumbnails","subFolders","setSubFolders","selectedSubFolder","setSelectedSubFolder","loadingFolders","setLoadingFolders","fileInputRef","isOnline","navigator","onLine","fetchSubFolders","request","_objectSpread","response","acquireTokenSilent","siteResponse","id","siteData","displayName","childrenResponse","data","value","item","console","log","err","handleFileChange","event","target","newFiles","Array","from","prev","generateThumbnails","newThumbnails","handleFileSelect","_fileInputRef$current","click","handleRemoveFile","index","filter","_","i","handleRemoveSelection","uploadImages","folderExists","imageUrls","url","push","totalSizeMB","acc","userEmail","username","sourceUrl","photoCount","parseFloat","toFixed","targetTeamName","logErr","acquireTokenPopup","then","message","handleUpload","round","e","elevation","sx","p","mt","children","variant","gutterBottom","fullWidth","mb","disabled","labelId","onChange","label","color","ml","accept","multiple","ref","style","display","alignItems","onClick","flexGrow","mr","title","container","spacing","xs","sm","md","position","component","image","alt","objectFit","top","right","backgroundColor","fontSize","noWrap","progress","currentFile","totalFiles","trim","severity"],"sources":["/home/vsts/work/1/s/src/ui-components/ImageUpload.tsx"],"sourcesContent":["// filepath: /workspaces/redIT_Baumgartner_BildUpload/src/ui-components/ImageUpload.tsx\nimport React, { useState, useRef, useEffect } from \"react\"; // Added useEffect\nimport { useMsal, useAccount } from \"@azure/msal-react\";\nimport { InteractionRequiredAuthError } from \"@azure/msal-browser\";\nimport { loginRequest } from \"../authConfig\";\n// Added Select, MenuItem, FormControl, InputLabel\nimport { TextField, Button, Typography, Box, Alert, Paper, Grid, IconButton, Card, CardMedia, CardContent, Select, MenuItem, FormControl, InputLabel, SelectChangeEvent } from \"@mui/material\";\nimport { Delete as DeleteIcon } from \"@mui/icons-material\";\nimport { db } from '../db';\nimport { logToSharePoint } from \"../utils/Logger\";\nimport { UploadProgress } from \"./UploadProgress\";\nimport { SubFolder } from '../db'; // Import shared interface\n\nexport interface Team {\n    id: string;\n    displayName: string;\n}\n\nexport interface Channel {\n    id: string;\n    displayName: string;\n}\n\ninterface ImageUploadProps {\n    team: Team;\n    channel: Channel;\n    onUploadSuccess: (urls: string[], files?: File[], base64Images?: string[]) => void;\n    onCustomTextChange: (text: string) => void;\n    customText: string;\n    // ÄNDERUNG: Callback Signatur erweitert um subFolder\n    onSaveOffline?: (files: File[], subFolder: string, onProgress?: (current: number, total: number) => void) => Promise<void> | void;\n    cachedSubFolders?: SubFolder[]; // New Prop\n    initialSelectedSubFolder?: string; // New prop for testing\n}\n\ninterface FileData {\n    name: string;\n    type: string;\n    size: number;\n    data: string;\n}\n\n// Hilfsfunktion: Base64 zu Blob\nconst dataURLToBlob = (dataURL: string): Blob => {\n    const arr = dataURL.split(',');\n    const mime = arr[0].match(/:(.*?);/)![1];\n    const bstr = atob(arr[1]);\n    let n = bstr.length;\n    const u8arr = new Uint8Array(n);\n    while (n--) {\n        u8arr[n] = bstr.charCodeAt(n);\n    }\n    return new Blob([u8arr], { type: mime });\n};\n\n// Neue Hilfsfunktion: Prüfe, ob \"General\"-Kanal existiert und gib den Pfad zurück\nexport const getFolderPath = (channelDisplayName: string): string => {\n    return `${channelDisplayName}/Bilder`;  // Direkt im Kanal\n};\n\n// Hilfsfunktionen außerhalb der Komponente definieren\nexport const checkFolderExists = async (accessToken: string, siteId: string, folderPath: string): Promise<boolean> => {\n    const checkResponse = await fetch(`https://graph.microsoft.com/v1.0/sites/${siteId}/drive/root:/${folderPath}`, {\n        headers: { Authorization: `Bearer ${accessToken}` },\n    });\n    return checkResponse.ok;\n};\n\nexport const createFolder = async (accessToken: string, siteId: string, folderPath: string): Promise<void> => {\n    const parentPath = folderPath.substring(0, folderPath.lastIndexOf('/'));  // z.B. \"Shared Documents/General\"\n    const folderName = folderPath.split('/').pop()!;  // z.B. \"Bilder\n    \n    const createResponse = await fetch(`https://graph.microsoft.com/v1.0/sites/${siteId}/drive/root:/${parentPath}:/children`, {\n        method: \"POST\",\n        headers: {\n            Authorization: `Bearer ${accessToken}`,\n            \"Content-Type\": \"application/json\",\n        },\n        body: JSON.stringify({\n            name: folderName,\n            folder: {},\n            \"@microsoft.graph.conflictBehavior\": \"rename\",\n        }),\n    });\n    \n    if (!createResponse.ok) {\n        throw new Error(`Failed to create ${folderName} folder`);\n    }\n};\n\nexport const uploadLargeFile = async (accessToken: string, siteId: string, file: File, folderPath: string): Promise<string> => {\n    const filePath = `${folderPath}/${file.name}`;\n    \n    // Erstelle Upload-Session\n    const sessionResponse = await fetch(`https://graph.microsoft.com/v1.0/sites/${siteId}/drive/root:/${filePath}:/createUploadSession`, {\n        method: \"POST\",\n        headers: {\n            Authorization: `Bearer ${accessToken}`,\n            \"Content-Type\": \"application/json\",\n        },\n    });\n    \n    if (!sessionResponse.ok) {\n        throw new Error(`Failed to create upload session for ${file.name}`);\n    }\n    \n    const sessionData = await sessionResponse.json();\n    const uploadUrl = sessionData.uploadUrl;\n    \n    // Lade in Chunks hoch (320KB Chunks)\n    const chunkSize = 327680; // 320KB\n    let uploadedBytes = 0;\n    \n    while (uploadedBytes < file.size) {\n        const chunk = file.slice(uploadedBytes, uploadedBytes + chunkSize);\n        const endByte = Math.min(uploadedBytes + chunk.size - 1, file.size - 1);\n        \n        const uploadResponse = await fetch(uploadUrl, {\n            method: \"PUT\",\n            headers: {\n                \"Content-Length\": chunk.size.toString(),\n                \"Content-Range\": `bytes ${uploadedBytes}-${endByte}/${file.size}`,\n            },\n            body: chunk,\n        });\n        \n        if (!uploadResponse.ok) {\n            throw new Error(`Failed to upload chunk for ${file.name}`);\n        }\n        \n        uploadedBytes += chunk.size;\n    }\n    \n    // Gib die Web-URL der hochgeladenen Datei zurück\n    const finalResponse = await fetch(`https://graph.microsoft.com/v1.0/sites/${siteId}/drive/root:/${filePath}`, {\n        headers: { Authorization: `Bearer ${accessToken}` },\n    });\n    const finalData = await finalResponse.json();\n    return finalData.webUrl;\n};\n\nexport const uploadSmallFile = async (accessToken: string, siteId: string, file: File, folderPath: string): Promise<string> => {\n    const uploadResponse = await fetch(`https://graph.microsoft.com/v1.0/sites/${siteId}/drive/root:/${folderPath}/${file.name}:/content`, {\n        method: \"PUT\",\n        headers: {\n            Authorization: `Bearer ${accessToken}`,\n            \"Content-Type\": file.type,\n        },\n        body: file,\n    });\n    \n    if (!uploadResponse.ok) {\n        const errorText = await uploadResponse.text();\n        throw new Error(`Failed to upload ${file.name}: ${uploadResponse.status} ${errorText}`);\n    }\n    \n    // Hole die Web-URL\n    const urlResponse = await fetch(`https://graph.microsoft.com/v1.0/sites/${siteId}/drive/root:/${folderPath}/${file.name}`, {\n        headers: { Authorization: `Bearer ${accessToken}` },\n    });\n    const urlData = await urlResponse.json();\n    return urlData.webUrl;\n};\n\n// Neue Hilfsfunktion: Bild skalieren und zu base64 encodieren\n// Exportieren, damit andere Komponenten sie nutzen können\nexport const resizeImage = (file: File, maxWidth: number = 200, maxHeight: number = 200, quality: number = 0.8): Promise<string> => {\n    return new Promise((resolve, reject) => {\n        const img = new Image();\n        img.onload = () => {\n            const canvas = document.createElement('canvas');\n            const ctx = canvas.getContext('2d')!;\n            \n            // Berechne neue Größe, behalte Aspect Ratio\n            let { width, height } = img;\n            if (width > height) {\n                if (width > maxWidth) {\n                    height = (height * maxWidth) / width;\n                    width = maxWidth;\n                }\n            } else {\n                if (height > maxHeight) {\n                    width = (width * maxHeight) / height;\n                    height = maxHeight;\n                }\n            }\n            \n            canvas.width = width;\n            canvas.height = height;\n            ctx.drawImage(img, 0, 0, width, height);\n            \n            // Zu base64 konvertieren (JPEG für kleinere Größe)\n            canvas.toBlob((blob) => {\n                if (blob) {\n                    const reader = new FileReader();\n                    reader.onload = () => resolve(reader.result as string);\n                    reader.onerror = reject;\n                    reader.readAsDataURL(blob);\n                } else {\n                    reject(new Error('Canvas toBlob failed'));\n                }\n            }, 'image/jpeg', quality);  // Verwende quality\n        };\n        img.onerror = reject;\n        img.src = URL.createObjectURL(file);\n    });\n};\n\n// Neue Hilfsfunktion: Mehrere Dateien zu base64 encodieren\nexport const encodeFilesToBase64 = async (files: File[]): Promise<string[]> => {\n    // Kein Limit mehr – alle Bilder erlauben\n    let base64Images = await Promise.all(files.map(file => resizeImage(file, 150, 150, 0.4)));  // Start mit 40% Qualität\n    let totalSize = base64Images.reduce((sum, img) => sum + (img.length * 0.75), 0);\n\n    // Reduziere Qualität weiter, wenn über 24 KB\n    let quality = 0.4;\n    while (totalSize > 24000 && quality > 0.1) {\n        quality -= 0.05;  // Kleinere Schritte für feinere Anpassung\n        base64Images = await Promise.all(files.map(file => resizeImage(file, 150, 150, quality)));\n        totalSize = base64Images.reduce((sum, img) => sum + (img.length * 0.75), 0);\n    }\n\n    return base64Images;\n};\n\nconst ImageUpload: React.FC<ImageUploadProps> = ({ \n    team, \n    channel, \n    onUploadSuccess, \n    onCustomTextChange, \n    customText, \n    onSaveOffline,\n    cachedSubFolders = [], // Default empty\n    initialSelectedSubFolder = \"\" // New prop for testing\n}) => {\n    const { instance, accounts } = useMsal();\n    const account = useAccount(accounts[0] || {});\n    const [selectedFiles, setSelectedFiles] = useState<File[]>([]);\n    const [uploading, setUploading] = useState<boolean>(false);\n    const [progressData, setProgressData] = useState({ current: 0, total: 0, percent: 0 });\n    const [error, setError] = useState<string | null>(null);\n    const [success, setSuccess] = useState<string | null>(null);\n    const [thumbnails, setThumbnails] = useState<string[]>([]);\n    \n    // NEW: State for Subfolders\n    const [subFolders, setSubFolders] = useState<SubFolder[]>([]);\n    const [selectedSubFolder, setSelectedSubFolder] = useState<string>(initialSelectedSubFolder); // Use initial value\n    const [loadingFolders, setLoadingFolders] = useState<boolean>(false);\n\n    const fileInputRef = useRef<HTMLInputElement>(null);\n    const isOnline = navigator.onLine;\n\n    // NEW: Fetch Subfolders when Channel changes\n    useEffect(() => {\n        const fetchSubFolders = async () => {\n            setSubFolders([]);\n            // Removed setSelectedSubFolder(\"\"); to keep initial value\n\n            // Offline or no account: Use cached subfolders\n            if (!account || !isOnline) {\n                if (cachedSubFolders && cachedSubFolders.length > 0) {\n                    setSubFolders(cachedSubFolders);\n                } else {\n                    setSubFolders([]);\n                }\n                setLoadingFolders(false);\n                return;\n            }\n            \n            setLoadingFolders(true);\n\n            const request = { ...loginRequest, account };\n\n            try {\n                const response = await instance.acquireTokenSilent(request);\n                const accessToken = response.accessToken;\n\n                // 1. Get Site ID\n                const siteResponse = await fetch(`https://graph.microsoft.com/v1.0/groups/${team.id}/sites/root`, {\n                    headers: { Authorization: `Bearer ${accessToken}` },\n                });\n                if (!siteResponse.ok) throw new Error(\"Failed to get site ID\");\n                const siteData = await siteResponse.json();\n                const siteId = siteData.id;\n\n                // 2. Get Path to \"Bilder\"\n                const folderPath = getFolderPath(channel.displayName); // e.g., \"General/Bilder\"\n\n                // 3. List Children of \"Bilder\"\n                const childrenResponse = await fetch(\n                    `https://graph.microsoft.com/v1.0/sites/${siteId}/drive/root:/${folderPath}:/children?filter=folder ne null&select=id,name`, \n                    { headers: { Authorization: `Bearer ${accessToken}` } }\n                );\n\n                if (childrenResponse.ok) {\n                    const data = await childrenResponse.json();\n                    setSubFolders(data.value.map((item: any) => ({ id: item.id, name: item.name })));\n                } else if (childrenResponse.status === 404) {\n                    // \"Bilder\" folder doesn't exist yet, which is fine.\n                    console.log(\"Bilder folder does not exist yet.\");\n                    setSubFolders([]); // Explicitly set to empty\n                }\n            } catch (err) {\n                console.error(\"Error fetching subfolders:\", err);\n                setSubFolders([]); // Set to empty on error\n            } finally {\n                setLoadingFolders(false);\n            }\n        };\n\n        fetchSubFolders();\n    }, [team.id, channel.displayName, account, isOnline, instance, cachedSubFolders]); // Add cachedSubFolders to deps\n\n    const handleFileChange = (event: React.ChangeEvent<HTMLInputElement>) => {\n        if (event.target.files && event.target.files.length > 0) {\n            const newFiles = Array.from(event.target.files);\n            setSelectedFiles(prev => [...prev, ...newFiles]);\n            \n            // Erzeuge Thumbnails für Vorschau (klein und schnell)\n            const generateThumbnails = async () => {\n                const newThumbnails = await Promise.all(newFiles.map(file => resizeImage(file, 100, 100, 0.5)));  // Kleine Thumbnails\n                setThumbnails(prev => [...prev, ...newThumbnails]);\n            };\n            generateThumbnails();\n            \n            event.target.value = \"\";  // Reset input\n        }\n    };\n\n    const handleFileSelect = () => {\n        fileInputRef.current?.click();\n    };\n\n    const handleRemoveFile = (index: number) => {\n        setSelectedFiles(prev => prev.filter((_, i) => i !== index));\n    };\n\n    const handleRemoveSelection = () => {\n        setSelectedFiles([]);\n        setThumbnails([]);  // Thumbnails zurücksetzen\n        if (fileInputRef.current) {\n            fileInputRef.current.value = \"\";\n        }\n    };\n\n    const uploadImages = async () => {\n        if (!account || selectedFiles.length === 0) return;\n\n        setUploading(true);\n        setError(null);\n        setSuccess(null);\n\n        const request = { ...loginRequest, account };\n\n        try {\n            const response = await instance.acquireTokenSilent(request);\n            const accessToken = response.accessToken;\n\n            // Schritt 1: Hole SharePoint Site-ID\n            const siteResponse = await fetch(`https://graph.microsoft.com/v1.0/groups/${team.id}/sites/root`, {\n                headers: { Authorization: `Bearer ${accessToken}` },\n            });\n            if (!siteResponse.ok) throw new Error(\"Failed to get site ID\");\n            const siteData = await siteResponse.json();\n            const siteId = siteData.id;\n\n            // Schritt 2: Bestimme den Ordner-Pfad\n            let folderPath = getFolderPath(channel.displayName);\n            \n            // NEW: Append Subfolder if selected\n            if (selectedSubFolder) {\n                folderPath = `${folderPath}/${selectedSubFolder}`;\n            }\n            \n            console.log('Verwende Ordner-Pfad:', folderPath);\n\n            // Schritt 3: Überprüfe und erstelle den Ordner\n            // Note: If subfolder is selected, we assume it exists (as per requirement), \n            // but checkFolderExists/createFolder handles the recursive creation if needed or we can rely on it existing.\n            // The current createFolder implementation might fail if parent doesn't exist, \n            // but since \"Bilder\" is parent and we check it, it should be fine.\n            const folderExists = await checkFolderExists(accessToken, siteId, folderPath);\n            if (!folderExists) {\n                await createFolder(accessToken, siteId, folderPath);\n            }\n\n            // Schritt 4: Lade Bilder hoch\n            const imageUrls: string[] = [];\n            for (const file of selectedFiles) {\n                let url: string;\n                if (file.size > 4 * 1024 * 1024) {\n                    url = await uploadLargeFile(accessToken, siteId, file, folderPath);\n                } else {\n                    url = await uploadSmallFile(accessToken, siteId, file, folderPath);\n                }\n                imageUrls.push(url);\n            }\n\n            // LOGGING HINZUFÜGEN\n            try {\n                const totalSizeMB = selectedFiles.reduce((acc, file) => acc + file.size, 0) / (1024 * 1024);\n                await logToSharePoint(accessToken, {\n                    userEmail: account.username,\n                    // NEW: Log the specific subfolder in sourceUrl\n                    sourceUrl: `Team: ${team.displayName} / Channel: ${channel.displayName} / Folder: ${selectedSubFolder || \"Root\"}`,\n                    photoCount: selectedFiles.length,\n                    totalSizeMB: parseFloat(totalSizeMB.toFixed(2)),\n                    targetTeamName: team.displayName,\n                    status: 'Success'\n                });\n            } catch (logErr) {\n                console.error(\"Logging failed but upload was successful\", logErr);\n            }\n\n            // Schritt 5: Encodiere alle Bilder\n            const base64Images = await encodeFilesToBase64(selectedFiles);\n\n            // Schritt 6: Erfolgreich hochgeladen - Callback aufrufen\n            onUploadSuccess(imageUrls, selectedFiles, base64Images);  // base64Images übergeben\n            setSuccess(`${selectedFiles.length} image(s) uploaded successfully!`);\n        } catch (err) {\n            // LOGGING ERROR (Optional, aber hilfreich)\n            if (account) {\n                 // Wir versuchen einen Error-Log zu senden, falls möglich (braucht Token)\n                 // Da wir hier im catch sind, ist accessToken evtl. nicht verfügbar, \n                 // daher lassen wir es hier weg um \"minimal\" zu bleiben und keine neuen Fehler zu riskieren.\n            }\n\n            if (err instanceof InteractionRequiredAuthError) {\n                instance.acquireTokenPopup(request).then(uploadImages);\n            } else {\n                setError(err instanceof Error ? err.message : \"Upload failed\");\n            }\n        } finally {\n            setUploading(false);\n        }\n    };\n\n    const handleUpload = async () => {\n        if (isOnline && account) {\n            if (onSaveOffline) {\n                setUploading(true);\n                setProgressData({ current: 0, total: selectedFiles.length, percent: 0 });\n                try {\n                    // Callback aktualisiert jetzt current und total\n                    // Pass selectedSubFolder\n                    await onSaveOffline(selectedFiles, selectedSubFolder, (current, total) => {\n                        // ÄNDERUNG: Prozentsatz basierend auf abgeschlossenen Bildern (current - 1)\n                        // Beispiel bei 4 Bildern:\n                        // Bild 1 startet -> (0/4)*100 = 0%\n                        // Bild 2 startet -> (1/4)*100 = 25%\n                        const percent = Math.round(((current - 1) / total) * 100);\n                        setProgressData({ current, total, percent });\n                    });\n                } catch (e) {\n                    console.error(e);\n                    setUploading(false);\n                }\n            } else {\n                await uploadImages();\n            }\n        } else {\n            // Offline: Speichere lokal\n            if (onSaveOffline) {\n                // Pass selectedSubFolder\n                await onSaveOffline(selectedFiles, selectedSubFolder);\n            }\n            setSuccess(`${selectedFiles.length} image(s) saved offline!`);\n            setSelectedFiles([]);\n        }\n    };\n\n    return (\n        <Paper elevation={1} sx={{ p: 2, mt: 2 }}>\n            <Typography variant=\"h6\" gutterBottom>\n                Bilder hochladen in Ordner \"Bilder\"\n            </Typography>\n            \n            {/* FIX: Show if online (even if empty, to show \"None found\") OR if we have cached subfolders */}\n            {(isOnline || subFolders.length > 0) && (\n                <FormControl fullWidth variant=\"outlined\" sx={{ mb: 2 }} disabled={loadingFolders || (subFolders.length === 0 && !isOnline)}>\n                    <InputLabel id=\"subfolder-select-label\">Unterordner auswählen (Optional)</InputLabel>\n                    <Select\n                        labelId=\"subfolder-select-label\"\n                        value={selectedSubFolder}\n                        onChange={(e: SelectChangeEvent) => setSelectedSubFolder(e.target.value as string)}\n                        label=\"Unterordner auswählen (Optional)\"\n                    >\n                        <MenuItem value=\"\">\n                            <em>Kein Unterordner (Direkt in \"Bilder\")</em>\n                        </MenuItem>\n                        {subFolders.map((folder) => (\n                            <MenuItem key={folder.id} value={folder.name}>\n                                {folder.name}\n                            </MenuItem>\n                        ))}\n                    </Select>\n                    {subFolders.length === 0 && !loadingFolders && (\n                        <Typography variant=\"caption\" color=\"textSecondary\" sx={{ ml: 1, mt: 0.5 }}>\n                            {isOnline ? \"Keine Unterordner gefunden.\" : \"Keine gecachten Unterordner verfügbar.\"}\n                        </Typography>\n                    )}\n                </FormControl>\n            )}\n\n            <input\n                type=\"file\"\n                accept=\"image/*\"\n                multiple\n                onChange={handleFileChange}\n                ref={fileInputRef}\n                style={{ display: 'none' }}\n            />\n            <Box sx={{ display: 'flex', alignItems: 'center', mb: 2 }}>\n                <Button\n                    variant=\"outlined\"\n                    color=\"primary\"\n                    onClick={handleFileSelect}\n                    sx={{ flexGrow: 1, mr: 1 }}\n                >\n                    {selectedFiles.length > 0 ? `${selectedFiles.length} Datei(en) ausgewählt` : \"Dateien auswählen\"}\n                </Button>\n                {selectedFiles.length > 0 && (\n                    <IconButton\n                        color=\"error\"\n                        onClick={handleRemoveSelection}\n                        title=\"Alle entfernen\"\n                    >\n                        <DeleteIcon />\n                    </IconButton>\n                )}\n            </Box>\n            {selectedFiles.length > 0 && (\n                <Box sx={{ mb: 2 }}>\n                    <Grid container spacing={2}>\n                        {selectedFiles.map((file, index) => (\n                            <Grid item xs={6} sm={4} md={3} key={index}>\n                                <Card>\n                                    <Box sx={{ position: 'relative' }}>\n                                        <CardMedia\n                                            component=\"img\"\n                                            height=\"100\"  // Kleiner für Performance\n                                            image={thumbnails[index] || ''}  // Verwende thumbnail\n                                            alt={file.name}\n                                            sx={{ objectFit: 'cover' }}\n                                        />\n                                        <IconButton\n                                            size=\"small\"\n                                            color=\"error\"\n                                            onClick={() => handleRemoveFile(index)}\n                                            sx={{\n                                                position: 'absolute',\n                                                top: 8,\n                                                right: 8,\n                                                backgroundColor: 'rgba(255, 255, 255, 0.8)',\n                                                '&:hover': { backgroundColor: 'rgba(255, 255, 255, 1)' }\n                                            }}\n                                            title=\"Entfernen\"\n                                        >\n                                            <DeleteIcon fontSize=\"small\" />\n                                        </IconButton>\n                                    </Box>\n                                    <CardContent sx={{ p: 1 }}>\n                                        <Typography variant=\"body2\" noWrap>\n                                            {file.name}\n                                        </Typography>\n                                        <Typography variant=\"caption\" color=\"text.secondary\">\n                                            {(file.size / 1024 / 1024).toFixed(2)} MB\n                                        </Typography>\n                                    </CardContent>\n                                </Card>\n                            </Grid>\n                        ))}\n                    </Grid>\n                </Box>\n            )}\n            {/* TextField immer anzeigen, wenn Dateien ausgewählt */}\n            {selectedFiles.length > 0 && (\n                <TextField\n                    fullWidth\n                    label=\"Nachricht zum Beitrag hinzufügen\"\n                    value={customText}\n                    onChange={(e) => onCustomTextChange(e.target.value)}\n                    variant=\"outlined\"\n                    sx={{ mb: 2 }}\n                />\n            )}\n\n            {/* NEU: Progress Komponente einbinden */}\n            <UploadProgress \n                uploading={uploading} \n                progress={progressData.percent} \n                currentFile={progressData.current}\n                totalFiles={progressData.total}\n            />\n\n            <Button\n                variant=\"contained\"\n                color=\"secondary\"\n                onClick={handleUpload}\n                disabled={!selectedFiles.length || uploading || (!isOnline && !customText.trim())}\n                fullWidth\n                sx={{ mb: 2 }}\n            >\n                {uploading ? `Uploading (${progressData.current}/${progressData.total})...` : (isOnline ? \"Datei(en) hochladen\" : \"Offline speichern\")}\n            </Button>\n            {error && <Alert severity=\"error\" sx={{ mt: 2 }}>Error: {error}</Alert>}\n            {success && <Alert severity=\"success\" sx={{ mt: 2 }}>{success}</Alert>}\n        </Paper>\n    );\n};\n\nexport default ImageUpload;"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}