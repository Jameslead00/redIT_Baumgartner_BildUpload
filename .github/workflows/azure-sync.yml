name: Sync to Azure Repo

on:
  push:
    branches:
      - main
      - dev
      - test-agent
  workflow_dispatch:

jobs:
  sync-to-azure:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Push to Azure Repo
        env:
          AZURE_TOKEN: ${{ secrets.AZURE_DEVOPS_TOKEN }}
          AZURE_REPO_URL: dev.azure.com/baumgartnerfenster/_git/RedIT
          USERNAME: james.leadbeater@redit.ch
        run: |
          # 1. Wir kodieren das PAT und speichern es in der Git-Konfiguration
          #    Dadurch weiß Git: "Wenn ich mit dev.azure.com spreche, nutze dieses Passwort."
          B64_PAT=$(printf ":%s" "$AZURE_TOKEN" | base64 -w 0)
          git config --global http.https://dev.azure.com.extraHeader "Authorization: Basic $B64_PAT"

          # 2. Wir fügen die Remote-URL hinzu.
          #    WICHTIG: Hier darf KEIN Token und KEIN 'git:' mehr stehen. Nur die reine Adresse.
          git remote add azure "https://$USERNAME@$AZURE_REPO_URL"
          
          echo "Pushing to Azure Repo..."
          git push azure --all --force
          git push azure --tags --force