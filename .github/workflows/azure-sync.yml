name: Sync to Azure Repo

on:
  push:
    branches:
      - main
      - dev
      - test-agent
  workflow_dispatch:

jobs:
  sync-to-azure:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Push to Azure Repo
        env:
          AZURE_TOKEN: ${{ secrets.AZURE_DEVOPS_TOKEN }}
          AZURE_REPO_URL: dev.azure.com/baumgartnerfenster/_git/RedIT
          USERNAME: james.leadbeater@redit.ch
        run: |
          # 1. Wir erstellen den Auth-Header mit BENUTZERNAME und TOKEN.
          #    Format für Basic Auth ist "username:password".
          #    Da wir das im Header machen, stört das '@' im Benutzernamen nicht.
          B64_AUTH=$(printf "%s:%s" "$USERNAME" "$AZURE_TOKEN" | base64 -w 0)
          
          # 2. Wir setzen den Header global für Git.
          git config --global http.extraHeader "Authorization: Basic $B64_AUTH"

          # 3. Remote hinzufügen (SAUBERE URL ohne Benutzername)
          git remote add azure "https://$AZURE_REPO_URL"
          
          echo "Pushing to Azure Repo..."
          git push azure --all --force
          git push azure --tags --force