name: Sync to Azure Repo

on:
  push:
    branches:
      - main
      - dev
      - test-agent
  workflow_dispatch:

jobs:
  sync-to-azure:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Push to Azure Repo
        env:
          AZURE_TOKEN: ${{ secrets.AZURE_DEVOPS_TOKEN }}
          AZURE_REPO_URL: dev.azure.com/baumgartnerfenster/_git/RedIT
        run: |
          # Konfiguriere Git, um den Token im Header zu senden (sicherer und robuster)
          # Wir kodieren ":<TOKEN>" in Base64 für Basic Auth. -w 0 verhindert Zeilenumbrüche.
          B64_PAT=$(printf ":%s" "$AZURE_TOKEN" | base64 -w 0)
          git config --global http.https://dev.azure.com.extraHeader "Authorization: Basic $B64_PAT"

          # Remote hinzufügen (ohne Token in der URL)
          git remote add azure "https://$AZURE_REPO_URL"
          
          echo "Pushing to Azure Repo..."
          git push azure --all --force
          git push azure --tags --force